<!DOCTYPE html>
<html lang="en">
<head>
<link rel="apple-touch-icon" href="./apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Chore Quest</title>

  <style>
    :root{
      --bg1:#070b18;
      --bg2:#111a35;
      --card: rgba(255,255,255,.92);
      --card2: rgba(255,255,255,.88);
      --ink:#0b1220;
      --muted:#334155;
      --stroke: 3px;
      --r1: 20px;
      --r2: 16px;
      --shadow: 0 20px 55px rgba(0,0,0,.28);
      --shadow2: 0 12px 26px rgba(0,0,0,.18);
      --good1:#4ade80;
      --good2:#16a34a;
      --warn1:#fde68a;
      --warn2:#f59e0b;
      --bad1:#fb7185;
      --bad2:#dc2626;
      --cool1:#67e8f9;
      --cool2:#2563eb;
      --magic1:#c4b5fd;
      --magic2:#7c3aed;
      --pink1:#f9a8d4;
      --pink2:#db2777;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      min-height:100vh;
      background:
        radial-gradient(900px 520px at 15% 20%, rgba(34,211,238,.20), transparent 60%),
        radial-gradient(900px 520px at 85% 22%, rgba(167,139,250,.22), transparent 62%),
        radial-gradient(900px 520px at 50% 85%, rgba(163,230,53,.16), transparent 62%),
        linear-gradient(135deg, var(--bg1), var(--bg2) 55%, #061a2b);
      overflow-x:hidden;
      -webkit-text-size-adjust: 100%;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .wrap{max-width:1100px; margin:0 auto; padding:16px 14px 44px;}

    /* Header */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      margin: 8px 0 14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .badge{
      width:54px; height:54px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(34,211,238,.92), rgba(167,139,250,.92));
      border: var(--stroke) solid rgba(255,255,255,.45);
      box-shadow: 0 14px 30px rgba(0,0,0,.30);
      position:relative; overflow:hidden;
    }
    .badge:before{
      content:"";
      position:absolute; inset:-10px;
      background:
        linear-gradient(45deg,
          rgba(255,255,255,.18) 0%,
          rgba(255,255,255,0) 35%,
          rgba(255,255,255,.18) 70%,
          rgba(255,255,255,0) 100%);
      transform: rotate(16deg);
    }
    .badge:after{
      content:"";
      position:absolute; left:50%; top:50%;
      width:18px; height:18px;
      transform: translate(-50%,-50%) rotate(16deg);
      border-radius:4px;
      background: rgba(11,18,32,.90);
      box-shadow: 0 0 0 3px rgba(255,255,255,.55);
    }

    h1{
      margin:0;
      font-size:2.0rem;
      letter-spacing:.2px;
      line-height:1.1;
      color: rgba(255,255,255,.96);
      text-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .sub{
      margin:6px 0 0;
      color: rgba(226,232,240,.92);
      font-weight:850;
      font-size:1.02rem;
      text-shadow: 0 10px 18px rgba(0,0,0,.22);
    }

    .tabs{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:10px 0 16px;}
    .tabBtn{
      border:none; cursor:pointer;
      padding:14px 18px;
      border-radius:999px;
      font-size:1.10rem;
      font-weight:950;
      box-shadow: var(--shadow2);
      transition: transform .08s ease, filter .12s ease;
      user-select:none;
      border: var(--stroke) solid rgba(255,255,255,.40);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .tabBtn:active{transform: scale(.97)}
    .kidTab{background: linear-gradient(135deg, rgba(34,211,238,.95), rgba(37,99,235,.95)); color:#08101f;}
    .parentTab{background: linear-gradient(135deg, rgba(163,230,53,.95), rgba(245,158,11,.95)); color:#08101f;}
    .tabActive{filter: saturate(1.15) contrast(1.05); outline: 3px solid rgba(255,255,255,.55);}

    /* Layout */
    .grid{display:grid; grid-template-columns: 1.15fr .85fr; gap:14px;}
    @media (max-width: 920px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background: var(--card);
      backdrop-filter: blur(10px);
      border-radius: var(--r1);
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
      border: var(--stroke) solid rgba(255,255,255,.70);
      position: relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(135deg, rgba(34,211,238,.07), rgba(167,139,250,.06), rgba(163,230,53,.05));
      pointer-events:none;
    }
    .card > *{position:relative; z-index:1;}

    .sticky{
      position: sticky;
      top: 10px;
      z-index: 50;
    }

    /* Kid dashboard */
    .heroRow{
      display:flex; align-items:flex-end; justify-content:space-between;
      flex-wrap:wrap; gap:12px; margin-bottom:10px;
    }
    .starsBig{
      display:flex; align-items:flex-end; gap:12px;
    }
    .starsEmoji{font-size: 3.1rem; line-height:1; filter: drop-shadow(0 14px 16px rgba(0,0,0,.14));}
    .starsNum{font-size: 5.8rem; font-weight: 1000; letter-spacing: -1px; line-height: .92;}
    .starsOut{font-size: 1.2rem; font-weight: 950; color: var(--muted); margin-bottom: 12px;}
    .miniRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;}

    .mini{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: var(--r2);
      font-weight:950;
      box-shadow: var(--shadow2);
      border: var(--stroke) solid rgba(0,0,0,.06);
      user-select:none;
      background: rgba(255,255,255,.92);
      min-width: 210px;
    }
    .mini .big{font-size:1.35rem; line-height:1;}
    .mini .small{font-size:.96rem; color:var(--muted); font-weight:900; line-height:1.1;}
    .miniWait{
      background: linear-gradient(135deg, rgba(245,158,11,.16), rgba(255,255,255,.92));
      border-color: rgba(245,158,11,.22);
    }
    .miniStrike{
      background: linear-gradient(135deg, rgba(220,38,38,.12), rgba(255,255,255,.92));
      border-color: rgba(220,38,38,.18);
    }

    .progressWrap{ margin: 2px 0 10px; }
    .progressTop{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap;
      font-weight:950; color: var(--muted);
    }
    .bar{
      margin-top:8px;
      height:18px;
      border-radius:999px;
      background: rgba(0,0,0,.08);
      border: var(--stroke) solid rgba(0,0,0,.06);
      overflow:hidden;
      box-shadow: var(--shadow2);
    }
    .fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(34,211,238,.95), rgba(37,99,235,.95));
      transition: width .35s ease;
    }

    .starsRow{
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
      padding: 8px 10px 0;
      margin-top: 2px;
      user-select:none;
      font-size:2.45rem;
    }
    .dim{filter: grayscale(1) opacity(.22); transform: scale(.92);}

    .goalLine{
      margin: 8px 0 0;
      text-align:center;
      color:var(--muted);
      font-weight:950;
      font-size:1.05rem;
    }
    .pill{
      display:inline-block;
      margin-left:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(34,211,238,.10);
      border: var(--stroke) solid rgba(34,211,238,.18);
      color:#08101f;
    }
    .statusLine{
      margin: 10px 0 0;
      text-align:center;
      font-weight:950;
      color: var(--muted);
    }

    .divider{height:2px; background:rgba(0,0,0,.08); margin:14px 0;}

    /* Sections / chores */
    .sectionTitle{font-size:1.45rem; font-weight:1000; margin:0 0 8px;}
    .note{margin: 0 0 10px; color: var(--muted); font-weight:900; font-size:1.02rem;}

    .helpRow{display:flex; justify-content:flex-end; margin: 0 0 8px;}
    .helpBtn{
      border:none; cursor:pointer;
      width:44px; height:44px;
      border-radius:999px;
      font-weight:1000;
      font-size:1.15rem;
      background: rgba(255,255,255,.92);
      border: var(--stroke) solid rgba(0,0,0,.06);
      box-shadow: var(--shadow2);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .helpBtn:active{transform: scale(.97)}

    ul{list-style:none; padding:0; margin:0;}

    .item{
      border-radius: var(--r2);
      padding: 12px;
      margin: 10px 0;
      background: linear-gradient(135deg, rgba(167,139,250,.10), rgba(255,255,255,.95));
      border: var(--stroke) solid rgba(167,139,250,.18);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .top{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; flex-wrap:wrap; margin-bottom:10px;
    }
    .name{
      font-size:1.18rem;
      font-weight:1000;
      letter-spacing:.1px;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .tag{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:1000;
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,.88);
      border: var(--stroke) solid rgba(0,0,0,.06);
      color: var(--muted);
      font-size:.98rem;
    }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:none;
      cursor:pointer;
      border-radius: var(--r2);
      font-size:1.10rem;
      font-weight:1000;
      padding: 14px 16px;
      box-shadow: var(--shadow2);
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
      border: var(--stroke) solid rgba(255,255,255,.52);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      overflow:hidden;
      min-width: 220px;
    }
    .btn:active{transform: scale(.97)}
    .btn:disabled{cursor:not-allowed; opacity:.70; filter:saturate(.75);}

    .bRed{background: linear-gradient(135deg, var(--bad1), var(--bad2)); color:#fff;}
    .bYel{background: linear-gradient(135deg, var(--warn1), var(--warn2)); color:#1c243a;}
    .bGrn{background: linear-gradient(135deg, var(--good1), var(--good2)); color:#062010;}
    .bBlu{background: linear-gradient(135deg, var(--cool1), var(--cool2)); color:#08101f;}
    .bPur{background: linear-gradient(135deg, var(--magic1), var(--magic2)); color:#08101f;}
    .bGry{background:#eef2f7; color:#1c243a; border-color: rgba(0,0,0,.06);}

    /* Hold-to-claim progress (no text labels) */
    .holdable::after{
      content:"";
      position:absolute;
      inset:0;
      background: rgba(255,255,255,.22);
      transform: translateX(calc(-100% + (var(--hold, 0) * 100%)));
      transition: transform .06s linear;
      pointer-events:none;
    }

    /* Fullscreen FX overlay */
    .fx{
      position:fixed;
      inset:0;
      min-height:100dvh;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
      background: rgba(2,6,23,.70);
      backdrop-filter: blur(6px);
      padding: 20px;
      pointer-events:auto;
    }
    .fxCard{
      width:min(680px, 95vw);
      background: rgba(255,255,255,.96);
      border-radius: 26px;
      border: var(--stroke) solid rgba(255,255,255,.55);
      box-shadow: 0 22px 60px rgba(0,0,0,.38);
      padding: 16px 16px 14px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .fxEmoji{
      font-size: 5.0rem;
      margin: 8px 0 6px;
      filter: drop-shadow(0 14px 16px rgba(0,0,0,.14));
    }
    .fxTitle{
      font-size: 2.2rem;
      font-weight: 1000;
      margin: 6px 0 4px;
      letter-spacing:.2px;
      color:#08101f;
    }
    .fxSub{
      margin: 0 0 12px;
      font-weight: 900;
      color: var(--muted);
      font-size: 1.08rem;
      white-space: pre-wrap;
    }
    .fxBtnRow{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .confettiLayer{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
    }
    .confetti{
      position:absolute;
      width:10px; height:14px;
      border-radius:3px;
      opacity:0;
      transform: translateY(10px) rotate(0deg);
      animation: confettiFly 1000ms ease-out forwards;
      box-shadow: 0 12px 18px rgba(0,0,0,.14);
    }
    @keyframes confettiFly{
      0%{opacity:1; transform: translateY(18px) rotate(0deg);}
      100%{opacity:0; transform: translateY(-180px) rotate(280deg);}
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      color:#fff;
      font-weight:1000;
      padding: 10px 14px;
      border-radius: 999px;
      box-shadow: 0 14px 34px rgba(0,0,0,.22);
      z-index:9999;
      user-select:none;
      border: var(--stroke) solid rgba(255,255,255,.20);
    }

    /* Parent */
    .hidden{display:none !important;}
    input, select{
      font-size:1.06rem;
      padding: 12px 12px;
      border-radius: var(--r2);
      border: var(--stroke) solid rgba(0,0,0,.10);
      outline:none;
      font-weight:850;
      background: rgba(255,255,255,.96);
    }
    input:focus, select:focus{border-color: rgba(34,211,238,.55)}
    .formRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;}
    .wide{min-width: 260px; flex:1}
    .small{width: 180px}

    .pillSmall{
      display:inline-block;
      padding:7px 10px;
      border-radius:999px;
      font-weight:1000;
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,.90);
      border: var(--stroke) solid rgba(0,0,0,.06);
      margin: 0 6px 6px 0;
    }

    /* Small chips */
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-weight:1000;
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,.92);
      border: var(--stroke) solid rgba(0,0,0,.06);
      user-select:none;
    }

    /* Morning / Evening grouped panels */
    .panel{
      border-radius: var(--r2);
      padding: 12px;
      margin: 10px 0;
      background: rgba(255,255,255,.78);
      border: var(--stroke) solid rgba(0,0,0,.06);
      box-shadow: var(--shadow2);
    }
    .panelTitle{
      display:flex; align-items:center; justify-content:space-between;
      flex-wrap:wrap; gap:10px;
      margin-bottom: 10px;
      font-weight:1000;
      font-size: 1.15rem;
    }

    .kidSelector{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .kidSelect{
      background: rgba(255,255,255,.18);
      border: var(--stroke) solid rgba(255,255,255,.35);
      color: rgba(255,255,255,.95);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 1000;
      box-shadow: 0 14px 30px rgba(0,0,0,.20);
      -webkit-tap-highlight-color: transparent;
    }
    .kidSelect option{color:#0b1220}
  </style>
</head>

<body>

  <!-- Fullscreen FX -->
  <div id="fx" class="fx" role="dialog" aria-modal="true" aria-label="Dialog">
    <div class="fxCard">
      <div id="confettiLayer" class="confettiLayer"></div>
      <div id="fxEmoji" class="fxEmoji">‚≠ê</div>
      <div id="fxTitle" class="fxTitle">Nice!</div>
      <div id="fxSub" class="fxSub"></div>
      <div class="fxBtnRow">
        <button class="btn bBlu" id="fxClose" type="button">Continue</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="badge" aria-hidden="true"></div>
        <div>
          <h1>Chore Quest</h1>
          <div class="sub">Hold red to claim. Bring iPad to parent for approval.</div>
        </div>
      </div>

      <div class="kidSelector" aria-label="Kid selector">
        <span class="chip" style="background: rgba(255,255,255,.20); border-color: rgba(255,255,255,.30); color: rgba(255,255,255,.92);">
          üëßüë¶ Kid
        </span>
        <select id="kidProfile" class="kidSelect" aria-label="Select kid">
          <option value="kid7">7-year-old</option>
          <option value="kid5">5-year-old</option>
        </select>
      </div>
    </div>

    <div class="tabs">
      <button class="tabBtn kidTab tabActive" id="kidTab" type="button">Kid Page</button>
      <button class="tabBtn parentTab" id="parentTab" type="button">Parent Page</button>
    </div>

    <!-- KID PAGE -->
    <div id="kidPage" class="grid">
      <div class="card sticky">
        <div class="heroRow">
          <div class="starsBig">
            <div class="starsEmoji">‚≠ê</div>
            <div class="starsNum"><span id="starsKid">0</span></div>
            <div class="starsOut">/10</div>
          </div>

          <div class="miniRow">
            <div class="mini miniWait">
              <div class="big">üü°</div>
              <div>
                <div><span style="font-size:1.15rem; font-weight:1000;">Waiting:</span>
                  <span id="waitingKid" style="font-size:1.25rem; font-weight:1000;">0</span>
                </div>
                <div class="small">Bring iPad to parent</div>
              </div>
            </div>

            <div class="mini miniStrike">
              <div class="big">‚ùå</div>
              <div>
                <div><span style="font-size:1.15rem; font-weight:1000;">Strikes:</span>
                  <span id="strikesKid" style="font-size:1.25rem; font-weight:1000;">0</span><span style="color:var(--muted)">/3</span>
                </div>
                <div class="small">3 strikes = lose 1 ‚≠ê</div>
              </div>
            </div>
          </div>
        </div>

        <div class="progressWrap">
          <div class="progressTop">
            <div>Progress</div>
            <div><span id="progressText">0/10 stars</span></div>
          </div>
          <div class="bar" aria-hidden="true">
            <div id="progressFill" class="fill"></div>
          </div>
        </div>

        <div class="starsRow" id="starsRow"></div>

        <div class="goalLine">
          Daily goal <span class="pill" id="goalPill">8 ‚≠ê</span>
          Perfect <span class="pill">10 ‚≠ê</span>
        </div>

        <div class="statusLine" id="goalStatus"></div>

        <div class="divider"></div>

        <div class="sectionTitle" style="margin-bottom:8px;">Daily Specials</div>
        <div class="btnRow" style="justify-content:center;">
          <button class="btn bBlu" id="bossBtn" type="button">üëë Boss Button (2 ‚≠ê)</button>
          <button class="btn bPur" id="mysteryBtn" type="button">üéÅ Mystery Chore</button>
        </div>
        <div class="note" id="specialsNote" style="text-align:center; margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="helpRow">
          <button class="helpBtn" id="helpBtn" type="button" aria-label="Help">?</button>
        </div>

        <div class="sectionTitle">Today‚Äôs Routine</div>
        <div class="note" id="routineNote">Morning + After School + Evening.</div>

        <div class="panel">
          <div class="panelTitle">üåÖ Morning</div>
          <ul id="morningList"></ul>
        </div>

        <div class="panel">
          <div class="panelTitle">üè´ After School</div>
          <ul id="afternoonList"></ul>
        </div>

        <div class="panel">
          <div class="panelTitle">üåô Evening</div>
          <ul id="eveningList"></ul>
        </div>

        <div class="panel">
          <div class="panelTitle">‚≠ê Extra Helps</div>
          <ul id="extrasList"></ul>
        </div>
      </div>
    </div>

    <!-- PARENT PAGE -->
    <div id="parentPage" class="hidden">
      <div class="card">
        <div class="sectionTitle">Parent Page</div>
        <div class="note">Enter passcode to unlock.</div>

        <div class="formRow">
          <input id="pass" class="wide" type="password" placeholder="Enter passcode"
                 autocomplete="off" autocapitalize="none" />
          <button class="btn bYel" id="unlock" type="button">Unlock</button>
          <button class="btn bGry" id="lock" type="button">Lock</button>
        </div>

        <div id="lockedNote" class="note" style="text-align:center; margin-top:10px;">Locked.</div>
      </div>

      <div id="parentControls" class="hidden">
        <div class="grid">
          <div class="card">
            <div class="sectionTitle">Today Summary</div>

            <div class="heroRow" style="margin-bottom:8px;">
              <div class="starsBig">
                <div class="starsEmoji">‚≠ê</div>
                <div class="starsNum"><span id="starsParent">0</span></div>
                <div class="starsOut">/10</div>
              </div>

              <div class="miniRow">
                <div class="mini miniStrike">
                  <div class="big">‚ùå</div>
                  <div>
                    <div><span style="font-size:1.15rem; font-weight:1000;">Strikes:</span>
                      <span id="strikesParent" style="font-size:1.25rem; font-weight:1000;">0</span><span style="color:var(--muted)">/3</span>
                    </div>
                    <div class="small">Parent controls only</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top:8px;">
              <span class="pillSmall">Red: <span id="countPending">0</span></span>
              <span class="pillSmall" style="background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.22);">Yellow: <span id="countClaimed">0</span></span>
              <span class="pillSmall" style="background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.18);">Green: <span id="countApproved">0</span></span>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Review Claimed Chores</div>
            <div class="note">Approve turns green. Decline resets to red and removes the earned star(s).</div>

            <div class="btnRow" style="margin-bottom:10px;">
              <button class="btn bGrn" id="approveAll" type="button">‚úÖ Approve All</button>
              <button class="btn bGry" id="declineSelected" type="button">‚ùå Decline Selected</button>
              <button class="btn bBlu" id="approveSelected" type="button">‚úÖ Approve Selected</button>
            </div>

            <ul id="reviewList"></ul>

            <div class="divider"></div>

            <div class="sectionTitle">Reset the Day</div>
            <div class="note">Sets stars/strikes to 0 and turns all chores back to red. Clears Boss selection for the day.</div>
            <div class="btnRow">
              <button class="btn bRed" id="resetDay" type="button">üîÑ Reset Day</button>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Manage Strikes</div>
            <div class="btnRow">
              <button class="btn bRed" id="addStrike" type="button">‚ùå Add Strike</button>
              <button class="btn bGry" id="undoStrike" type="button">‚Ü©Ô∏è Undo Strike</button>
              <button class="btn bGry" id="clearStrikes" type="button">Clear Strikes</button>
            </div>

            <div class="divider"></div>
            <div class="note" id="savedLine" style="text-align:center;">Last saved: ‚Äî</div>
          </div>

          <div class="card">
            <div class="sectionTitle">Settings & Chores</div>

            <div class="sectionTitle" style="font-size:1.18rem; margin-top:2px;">Mystery Chore Prompt</div>
            <div class="note">Kid can use it once per day.</div>
            <div class="formRow" style="justify-content:flex-start">
              <input id="mysteryInput" class="wide" type="text" placeholder="Enter today‚Äôs mystery prompt" />
              <button class="btn bPur" id="saveMystery" type="button">Save Prompt</button>
              <button class="btn bGry" id="clearMystery" type="button">Clear</button>
            </div>
            <div class="note" style="margin-top:8px;">Current prompt: <span id="mysteryStatus">None</span></div>

            <div class="divider"></div>

            <div class="sectionTitle" style="font-size:1.18rem; margin-top:2px;">Boss Button (2 ‚≠ê) ‚Äì pick today‚Äôs chore</div>
            <div class="note">Boss Button is inactive until you select a chore.</div>
            <div class="formRow" style="justify-content:flex-start">
              <select id="bossSelect" class="wide"></select>
              <button class="btn bBlu" id="saveBoss" type="button">Save Boss</button>
              <button class="btn bGry" id="clearBoss" type="button">Clear Boss</button>
            </div>
            <div class="note" style="margin-top:8px;">Boss chore: <span id="bossStatus">None</span></div>

            <div class="divider"></div>

            <div class="sectionTitle" style="font-size:1.18rem; margin-top:2px;">Sound Effects</div>
            <div class="formRow" style="justify-content:flex-start">
              <label style="font-weight:1000; color:var(--muted); align-self:center;">Sounds</label>
              <select id="soundSelect">
                <option value="on">On</option>
                <option value="off">Off</option>
              </select>
              <button class="btn bBlu" id="saveSound" type="button">Save</button>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle" style="font-size:1.18rem; margin-top:2px;">Kid Profile Defaults</div>
            <div class="note">Switch kid at the top of the app. Each iPad remembers its own progress.</div>

            <div class="divider"></div>

            <div class="sectionTitle" style="font-size:1.18rem; margin-top:2px;">Add Chore</div>
            <div class="formRow" style="justify-content:flex-start">
              <input id="newChore" class="wide" type="text" placeholder="New chore name (e.g., Wipe the table)" />
              <select id="newChoreGroup" class="small" aria-label="Group">
                <option value="morning">Morning</option>
                <option value="afternoon">After School</option>
                <option value="evening">Evening</option>
                <option value="extras">Extra Helps</option>
              </select>
              <button class="btn bPur" id="addChore" type="button">‚ûï Add</button>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Edit / Delete / Reset</div>
            <div class="note">All chores can be renamed or deleted. You can also move chores between groups.</div>
            <ul id="parentChoreList"></ul>

            <div class="divider"></div>

            <div class="sectionTitle">Chart Settings</div>
            <div class="formRow" style="justify-content:flex-start">
              <label style="font-weight:1000; color:var(--muted); align-self:center;">Points per chore</label>
              <input id="pointsPerChore" class="small" type="number" min="1" step="1" />
              <button class="btn bBlu" id="saveSettings" type="button">Save</button>
            </div>

            <div class="formRow" style="justify-content:flex-start; margin-top:6px;">
              <label style="font-weight:1000; color:var(--muted); align-self:center;">Auto daily reset</label>
              <select id="autoReset">
                <option value="on">On</option>
                <option value="off">Off</option>
              </select>
              <label style="font-weight:1000; color:var(--muted); align-self:center;">Daily goal stars</label>
              <input id="dailyGoal" class="small" type="number" min="1" max="10" step="1" />
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Save</div>
            <button class="btn bBlu" id="saveNow" type="button">üíæ Save Now</button>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
(() => {
  /*
    Chore Quest (Professional-grade single-file)
    - Two kid profiles (5 and 7) selectable at top; each iPad can pick one.
    - Grouped routine (Morning / After School / Evening / Extra Helps)
    - Hold-to-claim (3s), parent approval, strikes system, perfect day celebration
    - Boss Button (2‚≠ê) and Mystery Chore (parent prompt, once/day)
    - Polished FX overlay + toast; auto daily reset; localStorage persistence
  */

  const PASSCODE = "123";                // fixed (not editable)
  const MAX_STARS = 10;
  const STRIKES_MAX = 3;
  const HOLD_MS = 3000;

  const STORAGE_KEY = "chore_quest_v1_profiles";

  const PRAISE = [
    "Awesome work!",
    "Great job!",
    "Nice hustle!",
    "Super helper!",
    "Boom. Done!",
    "You crushed it!",
    "Way to go!",
    "High five!",
    "That was amazing!",
    "Proud of you!"
  ];

  // Defaults tuned for 5 and 7 year olds.
  // Keep it routine-based and predictable; keep extras optional.
  const DEFAULTS_BY_PROFILE = {
    kid5: {
      label: "5-year-old",
      pointsPerChore: 10,
      dailyGoalStars: 7,
      autoDailyReset: "on",
      soundOn: true,
      mysteryPrompt: "",
      bossChoreId: "",
      chores: [
        // Morning
        { group:"morning",  name:"üõèÔ∏è Make bed" },
        { group:"morning",  name:"ü™• Brush teeth (morning)" },
        { group:"morning",  name:"üëï Get dressed" },
        { group:"morning",  name:"ü•£ Eat breakfast and put dish in sink" },

        // After School
        { group:"afternoon", name:"üéí Put backpack and shoes away" },
        { group:"afternoon", name:"üß∏ Pick up toys (5 minutes)" },
        { group:"afternoon", name:"üìö Read a book (10 minutes)" },

        // Evening
        { group:"evening",  name:"üõÅ Bath / wash up (with parent)" },
        { group:"evening",  name:"ü™• Brush teeth (night)" },
        { group:"evening",  name:"üß∫ Put dirty clothes in hamper" },

        // Extras
        { group:"extras",   name:"üçΩÔ∏è Help set the table" },
        { group:"extras",   name:"üßΩ Wipe the table (with help)" }
      ]
    },
    kid7: {
      label: "7-year-old",
      pointsPerChore: 10,
      dailyGoalStars: 8,
      autoDailyReset: "on",
      soundOn: true,
      mysteryPrompt: "",
      bossChoreId: "",
      chores: [
        // Morning
        { group:"morning",  name:"üõèÔ∏è Make bed" },
        { group:"morning",  name:"ü™• Brush teeth (morning)" },
        { group:"morning",  name:"üëï Get dressed" },
        { group:"morning",  name:"ü•£ Breakfast + dish in sink / dishwasher" },

        // After School
        { group:"afternoon", name:"üéí Put backpack away + check folder" },
        { group:"afternoon", name:"üß∏ Clean room floor (5 minutes)" },
        { group:"afternoon", name:"üìñ Homework / practice (10‚Äì15 minutes)" },

        // Evening
        { group:"evening",  name:"ü™• Brush teeth (night)" },
        { group:"evening",  name:"üß∫ Put dirty clothes in hamper" },
        { group:"evening",  name:"üßæ Pack backpack / school items ready" },

        // Extras
        { group:"extras",   name:"üçΩÔ∏è Help set the table" },
        { group:"extras",   name:"üêæ Help with pet (if applicable)" }
      ]
    }
  };

  // ----- State model -----
  // Store separate app state per profile (kid5 vs kid7) so each iPad can use one.
  const emptyDayState = () => ({
    points: 0,
    strikes: 0,
    lastDateKey: dateKey(new Date()),
    lastPerfectDayKey: "",
    mysteryUsedKey: "",
    bossUsedKey: "",
    chores: [] // populated from template at init (with ids, status, etc.)
  });

  const defaultsRoot = () => ({
    activeProfile: "kid7",
    profiles: {
      kid5: null,
      kid7: null
    },
    meta: { lastSavedMs: 0 }
  });

  let root = loadRoot();
  let unlocked = false;

  // DOM
  const kidProfile = document.getElementById("kidProfile");

  const kidTab = document.getElementById("kidTab");
  const parentTab = document.getElementById("parentTab");
  const kidPage = document.getElementById("kidPage");
  const parentPage = document.getElementById("parentPage");

  const starsKid = document.getElementById("starsKid");
  const strikesKid = document.getElementById("strikesKid");
  const waitingKid = document.getElementById("waitingKid");
  const progressText = document.getElementById("progressText");
  const progressFill = document.getElementById("progressFill");
  const starsRow = document.getElementById("starsRow");
  const goalPill = document.getElementById("goalPill");
  const goalStatus = document.getElementById("goalStatus");
  const routineNote = document.getElementById("routineNote");

  const bossBtn = document.getElementById("bossBtn");
  const mysteryBtn = document.getElementById("mysteryBtn");
  const specialsNote = document.getElementById("specialsNote");

  const helpBtn = document.getElementById("helpBtn");

  const morningList = document.getElementById("morningList");
  const afternoonList = document.getElementById("afternoonList");
  const eveningList = document.getElementById("eveningList");
  const extrasList = document.getElementById("extrasList");

  // Parent
  const pass = document.getElementById("pass");
  const unlockBtn = document.getElementById("unlock");
  const lockBtn = document.getElementById("lock");
  const lockedNote = document.getElementById("lockedNote");
  const parentControls = document.getElementById("parentControls");

  const starsParent = document.getElementById("starsParent");
  const strikesParent = document.getElementById("strikesParent");
  const countPending = document.getElementById("countPending");
  const countClaimed = document.getElementById("countClaimed");
  const countApproved = document.getElementById("countApproved");

  const reviewList = document.getElementById("reviewList");
  const approveAll = document.getElementById("approveAll");
  const approveSelected = document.getElementById("approveSelected");
  const declineSelected = document.getElementById("declineSelected");

  const resetDayBtn = document.getElementById("resetDay");
  const addStrikeBtn = document.getElementById("addStrike");
  const undoStrikeBtn = document.getElementById("undoStrike");
  const clearStrikesBtn = document.getElementById("clearStrikes");

  const savedLine = document.getElementById("savedLine");

  const mysteryInput = document.getElementById("mysteryInput");
  const saveMysteryBtn = document.getElementById("saveMystery");
  const clearMysteryBtn = document.getElementById("clearMystery");
  const mysteryStatus = document.getElementById("mysteryStatus");

  const bossSelect = document.getElementById("bossSelect");
  const saveBossBtn = document.getElementById("saveBoss");
  const clearBossBtn = document.getElementById("clearBoss");
  const bossStatus = document.getElementById("bossStatus");

  const soundSelect = document.getElementById("soundSelect");
  const saveSoundBtn = document.getElementById("saveSound");

  const newChore = document.getElementById("newChore");
  const newChoreGroup = document.getElementById("newChoreGroup");
  const addChoreBtn = document.getElementById("addChore");
  const parentChoreList = document.getElementById("parentChoreList");

  const pointsPerChore = document.getElementById("pointsPerChore");
  const autoReset = document.getElementById("autoReset");
  const dailyGoal = document.getElementById("dailyGoal");
  const saveSettings = document.getElementById("saveSettings");
  const saveNow = document.getElementById("saveNow");

  // FX
  const fx = document.getElementById("fx");
  const confettiLayer = document.getElementById("confettiLayer");
  const fxEmoji = document.getElementById("fxEmoji");
  const fxTitle = document.getElementById("fxTitle");
  const fxSub = document.getElementById("fxSub");
  const fxClose = document.getElementById("fxClose");

  // Init profiles if missing
  ensureProfiles();

  // Apply active profile to selector
  kidProfile.value = root.activeProfile;

  // Daily reset per active profile
  maybeDailyReset();

  // Tabs
  kidTab.addEventListener("click", () => showTab("kid"));
  parentTab.addEventListener("click", () => {
    showTab("parent");
    if(!unlocked) toast("Ask a parent");
  });

  function showTab(which){
    if(which === "kid"){
      forceLockParent();
      kidPage.classList.remove("hidden");
      parentPage.classList.add("hidden");
      kidTab.classList.add("tabActive");
      parentTab.classList.remove("tabActive");
    } else {
      kidPage.classList.add("hidden");
      parentPage.classList.remove("hidden");
      parentTab.classList.add("tabActive");
      kidTab.classList.remove("tabActive");
      pass.value = "";
    }
  }

  function forceLockParent(){
    unlocked = false;
    parentControls.classList.add("hidden");
    lockedNote.textContent = "Locked.";
    pass.value = "";
  }

  // Profile selector (kid5 / kid7)
  kidProfile.addEventListener("change", () => {
    root.activeProfile = kidProfile.value === "kid5" ? "kid5" : "kid7";
    saveRoot();
    forceLockParent();
    maybeDailyReset();
    renderAll();
    toast("Switched kid");
  });

  // Unlock/lock
  unlockBtn.addEventListener("click", () => {
    if(pass.value === PASSCODE){
      unlocked = true;
      parentControls.classList.remove("hidden");
      lockedNote.textContent = "Unlocked.";
      syncParentFields();
      renderAll();
      toast("Unlocked");
    } else {
      forceLockParent();
      lockedNote.textContent = "Wrong passcode.";
      toast("Wrong passcode");
      if(active().soundOn) sfx("error");
    }
  });

  lockBtn.addEventListener("click", () => { forceLockParent(); toast("Locked"); });

  // Help
  helpBtn.addEventListener("click", () => {
    showFx({
      emoji:"‚ùì",
      title:"How it works",
      sub:
        "‚Ä¢ Red = ready. Hold red for 3 seconds to claim.\n" +
        "‚Ä¢ Yellow = waiting for parent.\n" +
        "‚Ä¢ Green = approved.\n\n" +
        "Tip: Bring the iPad to a parent after you claim.",
      confetti:false,
      sound:"arm"
    });
  });

  // Specials: Mystery (reveal on click, parent sets prompt, once/day)
  mysteryBtn.addEventListener("click", () => {
    const a = active();
    const prompt = (a.mysteryPrompt || "").trim();
    const today = dateKey(new Date());

    if(!prompt){
      toast("Ask a parent to set today‚Äôs mystery");
      if(a.soundOn) sfx("error");
      return;
    }
    if(a.state.mysteryUsedKey === today){
      toast("Already used today");
      if(a.soundOn) sfx("error");
      return;
    }

    showFx({ emoji:"üéÅ", title:"Mystery Chore!", sub:prompt, confetti:true, sound:"mystery" });

    a.state.chores.push(makeChore({
      name: "üéÅ " + prompt,
      group: "extras",
      pointsAwarded: a.pointsPerChore
    }));

    a.state.mysteryUsedKey = today;
    saveRoot();
    renderAll();
  });

  // Specials: Boss button (2 stars) once/day, parent picks a chore daily
  bossBtn.addEventListener("click", () => {
    const a = active();
    const today = dateKey(new Date());

    if(!a.bossChoreId){
      toast("Boss is not set yet");
      if(a.soundOn) sfx("error");
      return;
    }
    if(a.state.bossUsedKey === today){
      toast("Boss already used today");
      if(a.soundOn) sfx("error");
      return;
    }

    const c = a.state.chores.find(x => x.id === a.bossChoreId);
    if(!c){
      toast("Boss chore was deleted");
      a.bossChoreId = "";
      saveRoot();
      renderAll();
      return;
    }
    if(c.statusToday !== "pending"){
      toast("Boss chore is not red");
      if(a.soundOn) sfx("error");
      return;
    }

    claimChore(c.id, { multiplier: 2, emoji:"üëë", title:"Boss Claimed!" });
    a.state.bossUsedKey = today;
    saveRoot();
    renderAll();
  });

  // Parent: mystery prompt
  saveMysteryBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const a = active();
    const p = (mysteryInput.value || "").trim();
    if(!p) return toast("Enter a prompt");
    a.mysteryPrompt = p;
    a.state.mysteryUsedKey = "";
    saveRoot();
    renderAll();
    toast("Mystery saved");
  });

  clearMysteryBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const a = active();
    a.mysteryPrompt = "";
    saveRoot();
    renderAll();
    toast("Mystery cleared");
  });

  // Parent: boss pick
  saveBossBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const a = active();
    a.bossChoreId = bossSelect.value || "";
    a.state.bossUsedKey = "";
    saveRoot();
    renderAll();
    toast("Boss saved");
  });

  clearBossBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const a = active();
    a.bossChoreId = "";
    a.state.bossUsedKey = "";
    saveRoot();
    renderAll();
    toast("Boss cleared");
  });

  // Parent: sound
  saveSoundBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const a = active();
    a.soundOn = (soundSelect.value === "on");
    saveRoot();
    toast("Sound saved");
  });

  // Parent: add chore
  addChoreBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const a = active();
    const name = (newChore.value || "").trim();
    const group = (newChoreGroup.value || "extras");
    if(!name) return;

    if(a.state.chores.some(c => norm(c.name) === norm(name))) return toast("Already added");

    a.state.chores.push(makeChore({ name, group, pointsAwarded: a.pointsPerChore }));
    newChore.value = "";
    saveRoot();
    renderAll();
    toast("Chore added");
  });

  // Parent: strikes
  addStrikeBtn.addEventListener("click", () => addStrike());
  undoStrikeBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const a = active();
    a.state.strikes = clampInt(a.state.strikes - 1, 0, STRIKES_MAX);
    saveRoot(); renderAll(); toast("Strike undone");
  });
  clearStrikesBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const a = active();
    a.state.strikes = 0;
    saveRoot(); renderAll(); toast("Strikes cleared");
  });

  // Parent: approve/decline
  approveAll.addEventListener("click", () => {
    if(!unlocked) return;
    const a = active();
    const claimed = a.state.chores.filter(c => c.statusToday === "claimed");
    if(claimed.length === 0) return toast("No claimed chores");
    claimed.forEach(c => { c.statusToday = "approved"; c.approvedAllTime += 1; });
    saveRoot(); renderAll(); toast("Approved all ‚úÖ");
    if(a.soundOn) sfx("approve");
  });

  approveSelected.addEventListener("click", () => {
    if(!unlocked) return;
    const ids = selectedReviewIds();
    if(ids.length === 0) return toast("Select at least one");
    ids.forEach(id => approveChore(id));
    toast("Approved selected ‚úÖ");
  });

  declineSelected.addEventListener("click", () => {
    if(!unlocked) return;
    const ids = selectedReviewIds();
    if(ids.length === 0) return toast("Select at least one");
    ids.forEach(id => declineChore(id));
    toast("Declined selected ‚ùå");
  });

  function selectedReviewIds(){
    return [...reviewList.querySelectorAll("input[type='checkbox'][data-id]:checked")]
      .map(cb => cb.getAttribute("data-id"))
      .filter(Boolean);
  }

  // Parent: reset day
  resetDayBtn.addEventListener("click", () => {
    if(!unlocked) return;
    resetDay();
    saveRoot();
    renderAll();
    toast("Day reset");
  });

  // Parent: settings
  saveSettings.addEventListener("click", () => {
    if(!unlocked) return;
    const a = active();
    a.pointsPerChore = clampInt(pointsPerChore.value, 1, 100);
    a.autoDailyReset = autoReset.value === "off" ? "off" : "on";
    a.dailyGoalStars = clampInt(dailyGoal.value, 1, MAX_STARS);

    // update chore default award only if missing
    a.state.chores.forEach(c => {
      if(!Number.isFinite(Number(c.pointsAwarded))) c.pointsAwarded = a.pointsPerChore;
    });

    saveRoot();
    renderAll();
    toast("Saved settings");
  });

  saveNow.addEventListener("click", () => {
    if(!unlocked) return;
    saveRoot();
    toast("Saved");
  });

  // FX close
  fxClose.addEventListener("click", closeFx);
  fx.addEventListener("click", (e) => { if(e.target === fx) closeFx(); });
  function closeFx(){
    fx.style.display = "none";
    document.body.style.overflow = "";
  }

  // ----- Render -----
  renderAll();

  function renderAll(){
    const a = active();
    const stars = starsFromPoints(a);

    starsKid.textContent = stars;
    strikesKid.textContent = a.state.strikes;
    goalPill.textContent = `${clampInt(a.dailyGoalStars, 1, MAX_STARS)} ‚≠ê`;

    const waiting = a.state.chores.filter(c => c.statusToday === "claimed").length;
    waitingKid.textContent = waiting;

    progressText.textContent = `${stars}/${MAX_STARS} stars`;
    progressFill.style.width = `${Math.round((stars / MAX_STARS) * 100)}%`;

    starsRow.innerHTML = "";
    for(let i=1;i<=MAX_STARS;i++){
      const s = document.createElement("span");
      s.textContent = "‚≠ê";
      if(i > stars) s.classList.add("dim");
      starsRow.appendChild(s);
    }

    const goal = clampInt(a.dailyGoalStars, 1, MAX_STARS);
    goalStatus.textContent =
      (stars >= MAX_STARS) ? "Perfect day: 10 stars!"
      : (stars >= goal) ? `Goal reached: ${stars} stars (goal is ${goal}).`
      : `You have ${stars} stars. Goal is ${goal}.`;

    routineNote.textContent = (root.activeProfile === "kid5")
      ? "Simple routine for a great day."
      : "Routine + responsibility + independence.";

    // Specials state
    const today = dateKey(new Date());

    const bossReady = !!a.bossChoreId && a.state.bossUsedKey !== today;
    bossBtn.disabled = !bossReady;

    const bossName = a.bossChoreId ? (a.state.chores.find(c => c.id === a.bossChoreId)?.name || "") : "";
    const bossLine = a.bossChoreId ? `Boss: ${bossName}${a.state.bossUsedKey === today ? " (used)" : ""}` : "Boss is not set yet.";

    const prompt = (a.mysteryPrompt || "").trim();
    const mysteryReady = !!prompt && a.state.mysteryUsedKey !== today;
    mysteryBtn.disabled = !mysteryReady;
    const mysteryLine = !prompt ? "Mystery is not set yet." : (a.state.mysteryUsedKey === today ? "Mystery used today." : "Mystery is ready.");

    specialsNote.textContent = `${bossLine}  |  ${mysteryLine}`;

    // Kid lists by group
    renderGroupList(morningList, "morning");
    renderGroupList(afternoonList, "afternoon");
    renderGroupList(eveningList, "evening");
    renderGroupList(extrasList, "extras");

    if(unlocked){
      renderParentSummary();
      renderParentReview();
      renderParentChores();
      syncParentFields();
      renderBossSelect();
      renderSavedLine();
    }
  }

  function renderGroupList(container, group){
    const a = active();
    container.innerHTML = "";

    const groupChores = a.state.chores
      .filter(c => c.group === group)
      .sort((x,y) => statusWeight(x.statusToday) - statusWeight(y.statusToday) || (Number(x.createdAt)||0) - (Number(y.createdAt)||0));

    if(groupChores.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `<div class="name">No chores in this section.</div>`;
      container.appendChild(li);
      return;
    }

    groupChores.forEach(c => {
      const li = document.createElement("li");
      li.className = "item";

      const meta =
        c.statusToday === "pending"  ? "Red"
        : c.statusToday === "claimed" ? "Waiting"
        : "Approved";

      const btnClass =
        c.statusToday === "pending" ? "bRed"
        : c.statusToday === "claimed" ? "bYel"
        : "bGrn";

      const btnText =
        c.statusToday === "pending" ? "Claim"
        : c.statusToday === "claimed" ? "Claimed"
        : "Approved";

      const icon =
        c.statusToday === "pending" ? "üî¥"
        : c.statusToday === "claimed" ? "üü°"
        : "üü¢";

      const starsWorth = starsWorthText(c);

      li.innerHTML = `
        <div class="top">
          <div class="name">${icon} <span>${escapeHtml(c.name)}</span> <span class="tag">${meta}${starsWorth}</span></div>
          <div class="tag" style="background: rgba(255,255,255,.70);">${prettyGroup(group)}</div>
        </div>
        <div class="btnRow">
          <button class="btn ${btnClass} ${(c.statusToday === "pending") ? "holdable" : ""}" type="button"
            ${c.statusToday !== "pending" ? "disabled" : ""} aria-label="Claim">${btnText}</button>
        </div>
      `;

      const mainBtn = li.querySelector("button");
      if(c.statusToday === "pending"){
        attachHoldToClaim(mainBtn, () => claimChore(c.id));
      }

      container.appendChild(li);
    });
  }

  function prettyGroup(g){
    if(g==="morning") return "Morning";
    if(g==="afternoon") return "After School";
    if(g==="evening") return "Evening";
    return "Extra";
  }

  function starsWorthText(chore){
    const a = active();
    const pps = clampInt(a.pointsPerChore, 1, 100);
    const pts = clampInt(chore.pointsAwarded ?? pps, 1, 1000);
    const stars = Math.max(1, Math.round(pts / pps));
    return ` ‚Ä¢ ${stars}‚≠ê`;
  }

  // ----- Actions -----
  function claimChore(choreId, opts = {}){
    const a = active();
    const c = a.state.chores.find(x => x.id === choreId);
    if(!c || c.statusToday !== "pending") return;

    c.statusToday = "claimed";

    const multiplier = clampInt(opts.multiplier ?? 1, 1, 5);
    const award = clampInt((c.pointsAwarded ?? a.pointsPerChore) * multiplier, 1, 1000);

    const beforeStars = starsFromPoints(a);
    addPoints(a, award);
    const afterStars = starsFromPoints(a);

    // Move claimed toward bottom within group/status
    c.createdAt = Date.now() + 5;

    saveRoot();
    renderAll();

    const praise = PRAISE[Math.floor(Math.random()*PRAISE.length)];
    showFx({
      emoji: opts.emoji || (afterStars > beforeStars ? "‚≠ê" : "üéâ"),
      title: opts.title || praise,
      sub: (afterStars > beforeStars)
        ? "Star earned! Bring the iPad to a parent to approve."
        : "Claimed! Bring the iPad to a parent to approve.",
      confetti: true,
      sound: afterStars > beforeStars ? "star" : "claim"
    });

    maybePerfectDayCelebrate(beforeStars, afterStars);
  }

  function approveChore(choreId){
    if(!unlocked) return;
    const a = active();
    const c = a.state.chores.find(x => x.id === choreId);
    if(!c || c.statusToday !== "claimed") return;

    c.statusToday = "approved";
    c.approvedAllTime += 1;

    saveRoot();
    renderAll();
    if(a.soundOn) sfx("approve");
  }

  function declineChore(choreId){
    if(!unlocked) return;
    const a = active();
    const c = a.state.chores.find(x => x.id === choreId);
    if(!c || c.statusToday !== "claimed") return;

    const award = clampInt(c.pointsAwarded ?? a.pointsPerChore, 1, 1000);

    const beforeStars = starsFromPoints(a);
    addPoints(a, -award);
    const afterStars = starsFromPoints(a);

    c.statusToday = "pending";

    // If declined chore is boss selection, clear boss
    if(a.bossChoreId === c.id){
      a.bossChoreId = "";
      a.state.bossUsedKey = "";
    }

    saveRoot();
    renderAll();

    showFx({
      emoji:"‚ùå",
      title:"Declined",
      sub: (afterStars < beforeStars) ? "Star removed. Try again." : "Reset to red.",
      confetti:false,
      sound:"decline"
    });
  }

  function resetTodayStatus(choreId){
    if(!unlocked) return;
    const a = active();
    const c = a.state.chores.find(x => x.id === choreId);
    if(!c) return;

    if(c.statusToday === "claimed"){
      const award = clampInt(c.pointsAwarded ?? a.pointsPerChore, 1, 1000);
      addPoints(a, -award);
    }
    c.statusToday = "pending";

    if(a.bossChoreId === c.id){
      a.bossChoreId = "";
      a.state.bossUsedKey = "";
    }

    saveRoot();
    renderAll();
    toast("Reset to red");
  }

  function addStrike(){
    if(!unlocked) return;
    const a = active();

    a.state.strikes = clampInt(a.state.strikes + 1, 0, STRIKES_MAX);
    if(a.soundOn) sfx("strike");

    if(a.state.strikes >= STRIKES_MAX){
      a.state.strikes = 0;
      const beforeStars = starsFromPoints(a);
      if(beforeStars > 0){
        addPoints(a, -a.pointsPerChore);
        saveRoot();
        renderAll();
        showFx({ emoji:"üéà", title:"3 Strikes!", sub:"1 star lost.", confetti:true, sound:"lose" });
        return;
      }
      saveRoot(); renderAll();
      showFx({ emoji:"üéà", title:"3 Strikes!", sub:"Be careful next time.", confetti:false, sound:"strike" });
      return;
    }

    saveRoot();
    renderAll();
    showFx({ emoji:"üéà", title:"Strike Added", sub:`${a.state.strikes}/3`, confetti:false, sound:"strike" });
  }

  function resetDay(){
    const a = active();
    a.state.points = 0;
    a.state.strikes = 0;

    a.state.chores.forEach(c => c.statusToday = "pending");

    a.state.lastPerfectDayKey = "";
    a.state.mysteryUsedKey = "";
    a.state.bossUsedKey = "";
    a.bossChoreId = ""; // must set daily
    a.state.lastDateKey = dateKey(new Date());
  }

  function maybeDailyReset(){
    const a = active();
    if(a.autoDailyReset !== "on") return;
    const today = dateKey(new Date());
    if(a.state.lastDateKey !== today){
      resetDay();
      saveRoot();
    }
  }

  // ----- Parent render -----
  function renderParentSummary(){
    const a = active();
    const stars = starsFromPoints(a);

    starsParent.textContent = stars;
    strikesParent.textContent = a.state.strikes;

    let pending=0, claimed=0, approved=0;
    a.state.chores.forEach(c => {
      if(c.statusToday === "pending") pending++;
      else if(c.statusToday === "claimed") claimed++;
      else approved++;
    });

    countPending.textContent = pending;
    countClaimed.textContent = claimed;
    countApproved.textContent = approved;
  }

  function renderParentReview(){
    const a = active();
    reviewList.innerHTML = "";

    const claimedChores = a.state.chores
      .filter(c => c.statusToday === "claimed")
      .sort((x,y) => (Number(x.createdAt)||0) - (Number(y.createdAt)||0));

    if(claimedChores.length === 0){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `<div class="name">No claimed chores waiting right now.</div>`;
      reviewList.appendChild(li);
      return;
    }

    claimedChores.forEach(c => {
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `
        <div class="top">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <input type="checkbox" data-id="${escapeAttr(c.id)}" style="width:22px; height:22px;" />
            <div class="name">üü° ${escapeHtml(c.name)}</div>
          </div>
          <div class="tag">${(c.id === a.bossChoreId) ? "üëë Boss" : "Review"}</div>
        </div>
        <div class="btnRow">
          <button class="btn bGrn" type="button">‚úÖ Approve</button>
          <button class="btn bRed" type="button">‚ùå Decline</button>
        </div>
      `;
      const [ap, de] = li.querySelectorAll("button");
      ap.addEventListener("click", () => { approveChore(c.id); toast("Approved ‚úÖ"); });
      de.addEventListener("click", () => { declineChore(c.id); toast("Declined ‚ùå"); });
      reviewList.appendChild(li);
    });
  }

  function renderParentChores(){
    const a = active();
    parentChoreList.innerHTML = "";

    const sorted = [...a.state.chores].sort((x,y) => {
      // Keep routine stable: morning/afternoon/evening/extras, then status, then createdAt
      const g = groupWeight(x.group) - groupWeight(y.group);
      if(g !== 0) return g;
      const s = statusWeight(x.statusToday) - statusWeight(y.statusToday);
      if(s !== 0) return s;
      return (Number(x.createdAt)||0) - (Number(y.createdAt)||0);
    });

    sorted.forEach(c => {
      const li = document.createElement("li");
      li.className = "item";

      const statusChip =
        c.statusToday === "pending" ? `üî¥ Red`
        : c.statusToday === "claimed" ? `üü° Yellow`
        : `üü¢ Green`;

      li.innerHTML = `
        <div class="top">
          <div style="flex:1; min-width:240px;">
            <div class="note" style="margin:0 0 6px;">Name ${(c.id === a.bossChoreId) ? "(üëë Boss)" : ""}</div>
            <input class="wide" data-id="${escapeAttr(c.id)}" type="text" value="${escapeAttr(c.name)}" />
            <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <span class="tag">${statusChip}</span>
              <span class="tag">${prettyGroup(c.group)}</span>
              <label style="font-weight:950; color:var(--muted);">Move</label>
              <select data-move="${escapeAttr(c.id)}" class="small">
                <option value="morning">Morning</option>
                <option value="afternoon">After School</option>
                <option value="evening">Evening</option>
                <option value="extras">Extra Helps</option>
              </select>
            </div>
          </div>
          <div class="tag">Approved all-time: ${clampInt(c.approvedAllTime ?? 0, 0, 999999)}</div>
        </div>

        <div class="btnRow">
          <button class="btn bBlu" type="button">üíæ Save</button>
          <button class="btn bGry" type="button">‚Ü©Ô∏è Reset Today</button>
          <button class="btn bRed" type="button">üóë Delete</button>
        </div>
      `;

      const input = li.querySelector("input");
      const moveSel = li.querySelector("select[data-move]");
      moveSel.value = c.group || "extras";

      const [saveBtn, resetBtn2, delBtn] = li.querySelectorAll("button");

      saveBtn.addEventListener("click", () => {
        if(!unlocked) return;
        const newName = (input.value || "").trim();
        if(!newName) return toast("Enter a name");
        if(a.state.chores.some(x => x.id !== c.id && norm(x.name) === norm(newName))) return toast("Duplicate name");

        c.name = newName;
        c.group = moveSel.value || c.group;
        saveRoot();
        renderAll();
        toast("Saved");
      });

      moveSel.addEventListener("change", () => {
        if(!unlocked) return;
        c.group = moveSel.value || c.group;
        saveRoot();
        renderAll();
        toast("Moved");
      });

      resetBtn2.addEventListener("click", () => resetTodayStatus(c.id));

      delBtn.addEventListener("click", () => {
        if(!unlocked) return;

        // If deleting claimed chore, remove awarded points
        if(c.statusToday === "claimed"){
          const award = clampInt(c.pointsAwarded ?? a.pointsPerChore, 1, 1000);
          addPoints(a, -award);
        }

        if(a.bossChoreId === c.id){
          a.bossChoreId = "";
          a.state.bossUsedKey = "";
        }

        a.state.chores = a.state.chores.filter(x => x.id !== c.id);
        saveRoot();
        renderAll();
        toast("Deleted");
      });

      parentChoreList.appendChild(li);
    });
  }

  function renderBossSelect(){
    const a = active();
    bossSelect.innerHTML = "";

    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Select a chore‚Ä¶";
    bossSelect.appendChild(opt);

    // Only pending chores are eligible for boss
    const pending = a.state.chores.filter(c => c.statusToday === "pending");
    pending.forEach(c => {
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = `${prettyGroup(c.group)}: ${c.name}`;
      bossSelect.appendChild(o);
    });

    bossSelect.value = a.bossChoreId || "";
  }

  function syncParentFields(){
    const a = active();
    pointsPerChore.value = a.pointsPerChore;
    autoReset.value = a.autoDailyReset;
    dailyGoal.value = a.dailyGoalStars;
    soundSelect.value = a.soundOn ? "on" : "off";

    mysteryInput.value = a.mysteryPrompt || "";
    mysteryStatus.textContent = a.mysteryPrompt ? `"${a.mysteryPrompt}"` : "None";

    const bossName = a.bossChoreId ? (a.state.chores.find(c => c.id === a.bossChoreId)?.name || "") : "";
    bossStatus.textContent = a.bossChoreId ? `"${bossName}"` : "None";
  }

  function renderSavedLine(){
    const ms = Number(root.meta?.lastSavedMs) || 0;
    if(!ms){ savedLine.textContent = "Last saved: ‚Äî"; return; }
    const d = new Date(ms);
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    savedLine.textContent = `Last saved: ${hh}:${mm}`;
  }

  // ----- FX overlay -----
  function showFx({emoji, title, sub, confetti, sound}){
    fxEmoji.textContent = emoji || "‚≠ê";
    fxTitle.textContent = title || "Nice!";
    fxSub.textContent = (sub || "").toString();

    confettiLayer.innerHTML = "";
    if(confetti) confettiBurst(36);

    document.body.style.overflow = "hidden";
    fx.style.display = "flex";

    const a = active();
    if(a.soundOn && sound) sfx(sound);

    // auto-close after 4 seconds
    setTimeout(() => {
      if(fx.style.display === "flex"){
        fx.style.display = "none";
        document.body.style.overflow = "";
      }
    }, 4000);
  }

  function confettiBurst(count){
    const colors = ["#dc2626","#7c3aed","#2563eb","#16a34a","#f59e0b","#db2777","#22d3ee","#a3e635","#ffffff"];
    for(let i=0;i<count;i++){
      const c = document.createElement("div");
      c.className = "confetti";
      c.style.left = Math.floor(6 + Math.random()*88) + "%";
      c.style.top = Math.floor(62 + Math.random()*18) + "%";
      c.style.background = colors[Math.floor(Math.random()*colors.length)];
      c.style.animationDuration = (800 + Math.random()*650) + "ms";
      confettiLayer.appendChild(c);
      setTimeout(() => c.remove(), 1400);
    }
  }

  function maybePerfectDayCelebrate(beforeStars, afterStars){
    if(afterStars < MAX_STARS) return;
    if(beforeStars >= MAX_STARS) return;

    const a = active();
    const today = dateKey(new Date());
    if(a.state.lastPerfectDayKey === today) return;

    a.state.lastPerfectDayKey = today;
    saveRoot();

    showFx({
      emoji:"üèÜ",
      title:"PERFECT DAY!",
      sub:"10 stars unlocked. Incredible work.",
      confetti:true,
      sound:"perfect"
    });
  }

  // ----- Hold to claim -----
  function attachHoldToClaim(buttonEl, onClaim){
    let holdTimer = null;
    let raf = null;
    let start = 0;
    let startX = 0, startY = 0;

    const ARM_DELAY_MS = 180;
    const MOVE_CANCEL_PX = 10;

    const clear = () => {
      if(holdTimer) clearTimeout(holdTimer);
      holdTimer = null;
      if(raf) cancelAnimationFrame(raf);
      raf = null;
      buttonEl.style.setProperty("--hold", 0);
    };

    const tick = () => {
      const t = performance.now();
      const p = clamp01((t - start) / HOLD_MS);
      buttonEl.style.setProperty("--hold", p);
      if(p < 1 && holdTimer) raf = requestAnimationFrame(tick);
    };

    const begin = (e) => {
      if(buttonEl.disabled) return;

      startX = e.clientX || 0;
      startY = e.clientY || 0;

      clear();
      start = performance.now();

      // small arm delay reduces scroll misfires
      setTimeout(() => {}, ARM_DELAY_MS);

      holdTimer = setTimeout(() => { clear(); onClaim(); }, HOLD_MS);
      raf = requestAnimationFrame(tick);

      try{ buttonEl.setPointerCapture(e.pointerId); } catch(_){}

      const a = active();
      if(a.soundOn) sfx("arm");
    };

    const move = (e) => {
      if(!holdTimer) return;
      const dx = Math.abs((e.clientX||0) - startX);
      const dy = Math.abs((e.clientY||0) - startY);
      if(dx > MOVE_CANCEL_PX || dy > MOVE_CANCEL_PX) clear();
    };

    const end = () => clear();

    buttonEl.addEventListener("pointerdown", begin);
    buttonEl.addEventListener("pointermove", move);
    buttonEl.addEventListener("pointerup", end);
    buttonEl.addEventListener("pointercancel", end);
    buttonEl.addEventListener("pointerleave", end);
    buttonEl.addEventListener("contextmenu", (e) => e.preventDefault());
  }

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  // ----- Sound (WebAudio) -----
  function sfx(type){
    const a = active();
    if(!a.soundOn) return;

    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(!AudioCtx) return;

    let ctx;
    try{ ctx = new AudioCtx(); } catch(e){ return; }

    const now = ctx.currentTime;

    const beep = (freq, dur, gainVal, wave="sine") => {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = wave;
      o.frequency.setValueAtTime(freq, now);
      g.gain.setValueAtTime(gainVal, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
      o.connect(g); g.connect(ctx.destination);
      o.start(now); o.stop(now + dur);
    };

    const sweep = (f1, f2, dur, gainVal, wave="triangle") => {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = wave;
      o.frequency.setValueAtTime(f1, now);
      o.frequency.exponentialRampToValueAtTime(f2, now + dur);
      g.gain.setValueAtTime(gainVal, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
      o.connect(g); g.connect(ctx.destination);
      o.start(now); o.stop(now + dur);
    };

    switch(type){
      case "arm":     beep(520, 0.05, 0.045, "sine"); break;
      case "claim":   sweep(420, 620, 0.09, 0.055, "triangle"); break;
      case "star":    beep(880, 0.07, 0.06, "sine"); beep(1320, 0.06, 0.045, "sine"); break;
      case "approve": sweep(520, 780, 0.10, 0.055, "triangle"); break;
      case "decline": sweep(520, 260, 0.12, 0.05, "sawtooth"); break;
      case "strike":  beep(220, 0.12, 0.05, "square"); break;
      case "lose":    sweep(380, 190, 0.18, 0.055, "sawtooth"); break;
      case "mystery": beep(660, 0.06, 0.05, "sine"); beep(990, 0.06, 0.045, "sine"); beep(1320, 0.06, 0.04, "sine"); break;
      case "perfect":
        beep(523.25, 0.08, 0.055, "triangle");
        beep(659.25, 0.08, 0.05, "triangle");
        beep(783.99, 0.10, 0.05, "triangle");
        beep(1046.5, 0.14, 0.045, "triangle");
        break;
      case "error":   beep(180, 0.10, 0.05, "square"); break;
      default:        beep(520, 0.06, 0.04, "sine");
    }

    setTimeout(() => { try{ ctx.close(); } catch(_){ } }, 250);
  }

  // ----- Storage / init -----
  function loadRoot(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultsRoot();
      const parsed = JSON.parse(raw);
      const merged = defaultsRoot();
      Object.assign(merged, parsed);
      if(!merged.profiles || typeof merged.profiles !== "object") merged.profiles = {kid5:null,kid7:null};
      if(!merged.meta || typeof merged.meta !== "object") merged.meta = { lastSavedMs: 0 };
      merged.activeProfile = (merged.activeProfile === "kid5") ? "kid5" : "kid7";
      return merged;
    } catch(e){
      return defaultsRoot();
    }
  }

  function saveRoot(){
    try{
      root.meta = root.meta || {};
      root.meta.lastSavedMs = Date.now();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(root));
    } catch(e){}
  }

  function ensureProfiles(){
    ["kid5","kid7"].forEach(k => {
      if(!root.profiles[k]) root.profiles[k] = buildProfileFromDefaults(k);
      hardenProfile(root.profiles[k], k);
    });
    saveRoot();
  }

  function buildProfileFromDefaults(key){
    const d = DEFAULTS_BY_PROFILE[key];
    const state = emptyDayState();

    const profile = {
      key,
      label: d.label,
      pointsPerChore: d.pointsPerChore,
      dailyGoalStars: d.dailyGoalStars,
      autoDailyReset: d.autoDailyReset,
      soundOn: d.soundOn,
      mysteryPrompt: d.mysteryPrompt,
      bossChoreId: d.bossChoreId,
      state
    };

    // Populate chores from templates
    state.chores = d.chores.map((t, idx) => makeChore({
      name: t.name,
      group: t.group,
      pointsAwarded: d.pointsPerChore,
      createdAt: Date.now() + idx
    }));

    return profile;
  }

  function hardenProfile(p, key){
    const d = DEFAULTS_BY_PROFILE[key];

    p.key = key;
    p.label = (p.label || d.label || key).toString();

    p.pointsPerChore = clampInt(p.pointsPerChore ?? d.pointsPerChore, 1, 100);
    p.dailyGoalStars = clampInt(p.dailyGoalStars ?? d.dailyGoalStars, 1, MAX_STARS);
    p.autoDailyReset = (p.autoDailyReset === "off") ? "off" : "on";
    p.soundOn = !!p.soundOn;

    p.mysteryPrompt = (p.mysteryPrompt || "").toString();
    p.bossChoreId = (p.bossChoreId || "").toString();

    if(!p.state || typeof p.state !== "object") p.state = emptyDayState();
    if(!Array.isArray(p.state.chores)) p.state.chores = [];

    // normalize chores
    p.state.chores = p.state.chores.map(c => ({
      id: c.id || rid(),
      name: (c.name || "Chore").toString(),
      group: normalizeGroup(c.group),
      statusToday: normalizeStatus(c.statusToday),
      approvedAllTime: clampInt(c.approvedAllTime ?? 0, 0, 999999),
      createdAt: Number(c.createdAt) || Date.now(),
      pointsAwarded: clampInt(c.pointsAwarded ?? p.pointsPerChore, 1, 1000)
    }));

    // If profile is empty (should not happen), repopulate
    if(p.state.chores.length === 0){
      p.state.chores = d.chores.map((t, idx) => makeChore({
        name: t.name,
        group: t.group,
        pointsAwarded: p.pointsPerChore,
        createdAt: Date.now() + idx
      }));
    }

    const maxPoints = MAX_STARS * p.pointsPerChore * 3;
    p.state.points = clampInt(p.state.points ?? 0, 0, maxPoints);
    p.state.strikes = clampInt(p.state.strikes ?? 0, 0, STRIKES_MAX);
    p.state.lastDateKey = (p.state.lastDateKey || dateKey(new Date())).toString();
    p.state.lastPerfectDayKey = (p.state.lastPerfectDayKey || "").toString();
    p.state.mysteryUsedKey = (p.state.mysteryUsedKey || "").toString();
    p.state.bossUsedKey = (p.state.bossUsedKey || "").toString();

    // clear boss if chore missing
    if(p.bossChoreId && !p.state.chores.some(c => c.id === p.bossChoreId)){
      p.bossChoreId = "";
      p.state.bossUsedKey = "";
    }
  }

  function active(){
    return root.profiles[root.activeProfile];
  }

  function makeChore({name, group, pointsAwarded, createdAt}){
    return {
      id: rid(),
      name: (name || "Chore").toString(),
      group: normalizeGroup(group),
      statusToday: "pending",
      approvedAllTime: 0,
      createdAt: Number(createdAt) || Date.now(),
      pointsAwarded: clampInt(pointsAwarded ?? active().pointsPerChore, 1, 1000)
    };
  }

  function normalizeGroup(g){
    return (g === "morning" || g === "afternoon" || g === "evening" || g === "extras") ? g : "extras";
  }

  function normalizeStatus(s){
    return (s === "claimed" || s === "approved" || s === "pending") ? s : "pending";
  }

  function statusWeight(s){
    return (s === "pending") ? 0 : (s === "claimed" ? 1 : 2);
  }

  function groupWeight(g){
    if(g==="morning") return 0;
    if(g==="afternoon") return 1;
    if(g==="evening") return 2;
    return 3;
  }

  // Points/stars model
  function addPoints(profile, delta){
    const maxPoints = MAX_STARS * clampInt(profile.pointsPerChore, 1, 100) * 3;
    profile.state.points = clampInt(profile.state.points + delta, 0, maxPoints);
  }

  function starsFromPoints(profile){
    const pps = clampInt(profile.pointsPerChore, 1, 100);
    return clampInt(Math.floor(profile.state.points / pps), 0, MAX_STARS);
  }

  // ----- Helpers -----
  function clampInt(v, min, max){
    const n = Number(v);
    if(!Number.isFinite(n)) return min;
    return Math.max(min, Math.min(max, Math.round(n)));
  }

  function dateKey(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function rid(){
    try{
      if(crypto && crypto.randomUUID) return "c_" + crypto.randomUUID();
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return "c_" + a[0].toString(16) + a[1].toString(16);
    } catch(e){
      return "c_" + Math.random().toString(16).slice(2);
    }
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function escapeAttr(str){ return escapeHtml(str); }

  function toast(msg){
    const t = document.createElement("div");
    t.className = "toast";
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 4000);
  }

  function norm(s){
    return String(s||"").trim().toLowerCase();
  }

})();
</script>
</body>
</html>
