<!DOCTYPE html>
<html lang="en">
<head>
<link rel="apple-touch-icon" href="./apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chore Chart</title>

  <style>
    :root{
      --ink:#0b1220;
      --muted:#334155;
      --card: rgba(255,255,255,.92);
      --shadow: 0 18px 44px rgba(0,0,0,.22);
      --shadow2: 0 12px 26px rgba(0,0,0,.16);
      --radius: 18px;
      --radius2: 14px;
      --stroke: 3px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      min-height:100vh;
      background:
        radial-gradient(900px 520px at 12% 18%, rgba(34,211,238,.22), transparent 60%),
        radial-gradient(900px 520px at 88% 22%, rgba(167,139,250,.22), transparent 62%),
        radial-gradient(900px 520px at 50% 88%, rgba(163,230,53,.18), transparent 62%),
        linear-gradient(135deg, #0b1020, #1a1030 45%, #061a2b);
      overflow-x:hidden;
      -webkit-text-size-adjust: 100%;
    }

    .wrap{max-width:1100px; margin:0 auto; padding:18px 14px 44px;}

    .header{
      display:flex; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; gap:12px;
      margin: 8px 0 12px;
    }
    .titleWrap{display:flex; align-items:center; gap:12px;}

    .robloxBadge{
      width:52px; height:52px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(34,211,238,.85), rgba(167,139,250,.85));
      border: var(--stroke) solid rgba(255,255,255,.45);
      box-shadow: 0 14px 30px rgba(0,0,0,.30);
      position:relative;
      overflow:hidden;
    }
    .robloxBadge:before{
      content:"";
      position:absolute; inset:-10px;
      background:
        linear-gradient(45deg,
          rgba(255,255,255,.18) 0%,
          rgba(255,255,255,0) 35%,
          rgba(255,255,255,.18) 70%,
          rgba(255,255,255,0) 100%);
      transform: rotate(18deg);
    }
    .robloxBadge:after{
      content:"";
      position:absolute; left:50%; top:50%;
      width:18px; height:18px;
      transform: translate(-50%,-50%) rotate(18deg);
      border-radius:4px;
      background: rgba(11,18,32,.88);
      box-shadow: 0 0 0 3px rgba(255,255,255,.55);
    }

    h1{
      margin:0;
      font-size:2.1rem;
      letter-spacing:.2px;
      line-height:1.1;
      color: rgba(255,255,255,.95);
      text-shadow: 0 10px 24px rgba(0,0,0,.35);
    }
    .subtitle{
      margin:6px 0 0;
      color: rgba(226,232,240,.90);
      font-weight:850;
      font-size:1.02rem;
      text-shadow: 0 10px 18px rgba(0,0,0,.22);
    }

    .tabs{display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:14px 0 16px;}
    .tabBtn{
      border:none; cursor:pointer;
      padding:14px 18px;
      border-radius:999px;
      font-size:1.12rem;
      font-weight:950;
      box-shadow: var(--shadow2);
      transition: transform .08s ease, filter .12s ease;
      user-select:none;
      border: var(--stroke) solid rgba(255,255,255,.40);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .tabBtn:active{transform: scale(.97)}
    .kidTab{background: linear-gradient(135deg, rgba(34,211,238,.95), rgba(37,99,235,.95)); color:#08101f;}
    .parentTab{background: linear-gradient(135deg, rgba(163,230,53,.95), rgba(245,158,11,.95)); color:#08101f;}
    .tabActive{filter: saturate(1.15) contrast(1.05); outline: 3px solid rgba(255,255,255,.55);}

    .grid{display:grid; grid-template-columns: 1.15fr .85fr; gap:14px;}
    @media (max-width: 920px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background: var(--card);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
      border: var(--stroke) solid rgba(255,255,255,.70);
      position: relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(135deg, rgba(34,211,238,.08), rgba(167,139,250,.07), rgba(163,230,53,.06));
      pointer-events:none;
    }
    .card > *{position:relative; z-index:1;}

    /* Sticky kid header card */
    .stickyKidHeader{
      position: sticky;
      top: 10px;
      z-index: 50;
    }

    /* BIG STAR COUNT */
    .starHero{display:flex; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom: 8px;}
    .starCountBig{display:flex; align-items:flex-end; gap:12px;}
    .starEmojiBig{font-size: 3.3rem; line-height:1; filter: drop-shadow(0 14px 16px rgba(0,0,0,.14));}
    .starNumberBig{font-size: 6.0rem; font-weight: 1000; letter-spacing: -1px; line-height: .92; text-shadow: 0 2px 0 rgba(0,0,0,.05);}
    .starOutOf{font-size: 1.2rem; font-weight: 950; color: var(--muted); margin-bottom: 12px;}

    .miniBadges{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;}
    .badge{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: var(--radius2);
      font-weight:950;
      box-shadow: var(--shadow2);
      border: var(--stroke) solid rgba(0,0,0,.06);
      user-select:none;
      background: rgba(255,255,255,.92);
    }
    .badge .big{font-size:1.35rem; line-height:1;}
    .badge .small{font-size:.96rem; color:var(--muted); font-weight:900; line-height:1.1;}
    .badgeStrike{
      background: linear-gradient(135deg, rgba(220,38,38,.12), rgba(255,255,255,.92));
      border-color: rgba(220,38,38,.18);
    }

    .badgeQueue{
      background: linear-gradient(135deg, rgba(245,158,11,.16), rgba(255,255,255,.92));
      border-color: rgba(245,158,11,.22);
    }

    /* Progress bar */
    .progressWrap{ margin: 2px 0 8px; }
    .progressTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      font-weight:950; color: var(--muted);
    }
    .progressBar{
      margin-top:8px;
      height:18px;
      border-radius:999px;
      background: rgba(0,0,0,.08);
      border: var(--stroke) solid rgba(0,0,0,.06);
      overflow:hidden;
      box-shadow: var(--shadow2);
    }
    .progressFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(34,211,238,.95), rgba(37,99,235,.95));
      transition: width .35s ease;
    }

    .goalLine{
      margin: 6px 0 0;
      text-align:center;
      color:var(--muted);
      font-weight:950;
      font-size:1.05rem;
    }
    .goalPill{
      display:inline-block;
      margin-left:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(34,211,238,.10);
      border: var(--stroke) solid rgba(34,211,238,.18);
      color:#08101f;
    }
    .statusLine{margin: 10px 0 0; text-align:center; font-weight:950; color: var(--muted);}

    /* Stars row */
    .starsRow{
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
      padding: 8px 10px 2px;
      margin-top: 2px;
      user-select:none;
      font-size:2.55rem;
    }
    .starDim{filter: grayscale(1) opacity(.22); transform: scale(.92);}

    /* Chores */
    .sectionTitle{font-size:1.45rem; font-weight:1000; margin:0 0 8px;}
    .smallNote{margin: 0 0 10px; color: var(--muted); font-weight:900; font-size:1.02rem;}
    ul{list-style:none; padding:0; margin:0;}

    .choreItem{
      border-radius: var(--radius2);
      padding: 12px;
      margin: 10px 0;
      background: linear-gradient(135deg, rgba(167,139,250,.10), rgba(255,255,255,.95));
      border: var(--stroke) solid rgba(167,139,250,.18);
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
    }
    .choreTop{display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;}
    .choreName{font-size:1.18rem; font-weight:1000; letter-spacing:.1px;}
    .choreMeta{font-size:1.02rem; font-weight:900; color: var(--muted);}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:none;
      cursor:pointer;
      border-radius: var(--radius2);
      font-size:1.10rem;
      font-weight:1000;
      padding: 14px 16px;
      box-shadow: var(--shadow2);
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
      border: var(--stroke) solid rgba(255,255,255,.52);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      position:relative;
      overflow:hidden;
      min-width: 220px;
    }
    .btn:active{transform: scale(.97)}
    .btn:disabled{cursor:not-allowed; opacity:.70; filter:saturate(.75);}

    .btnRed{background: linear-gradient(135deg, #fb7185, #dc2626); color:#fff;}
    .btnYellow{background: linear-gradient(135deg, #fde68a, #f59e0b); color:#1c243a;}
    .btnGreen{background: linear-gradient(135deg, #4ade80, #16a34a); color:#062010;}
    .btnStrike{background: linear-gradient(135deg, #fb7185, #dc2626); color:#fff;}
    .btnBlue{background: linear-gradient(135deg, #67e8f9, #2563eb); color:#08101f;}
    .btnPurple{background: linear-gradient(135deg, #c4b5fd, #7c3aed); color:#08101f;}
    .btnGray{background:#eef2f7; color:#1c243a; border-color: rgba(0,0,0,.06);}

    /* Hold-to-claim progress (no text labels) */
    .holdable::after{
      content:"";
      position:absolute;
      inset:0;
      background: rgba(255,255,255,.22);
      transform: translateX(calc(-100% + (var(--hold, 0) * 100%)));
      transition: transform .06s linear;
      pointer-events:none;
    }

    /* Parent page */
    .hidden{display:none !important;}
    input, select{
      font-size:1.06rem;
      padding: 12px 12px;
      border-radius: var(--radius2);
      border: var(--stroke) solid rgba(0,0,0,.10);
      outline:none;
      font-weight:850;
      background: rgba(255,255,255,.96);
    }
    input:focus, select:focus{border-color: rgba(34,211,238,.55)}
    .formRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;}
    .inputWide{min-width: 260px; flex:1}
    .inputSmall{width: 160px}
    .divider{height:2px; background:rgba(0,0,0,.08); margin:14px 0}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      color:#fff;
      font-weight:1000;
      padding: 10px 14px;
      border-radius: 999px;
      box-shadow: 0 14px 34px rgba(0,0,0,.22);
      z-index:9999;
      user-select:none;
      border: var(--stroke) solid rgba(255,255,255,.20);
    }

    /* FULLSCREEN FX OVERLAY */
    .fxOverlay{
      position:fixed;
      inset:0;
      min-height:100dvh;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
      background: rgba(2,6,23,.70);
      backdrop-filter: blur(6px);
      padding: 20px;
      pointer-events:auto;
    }
    .fxCard{
      width:min(640px, 94vw);
      background: rgba(255,255,255,.95);
      border-radius: 26px;
      border: var(--stroke) solid rgba(255,255,255,.55);
      box-shadow: 0 22px 60px rgba(0,0,0,.38);
      padding: 16px 16px 14px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .fxEmoji{
      font-size: 5.0rem;
      margin: 8px 0 6px;
      filter: drop-shadow(0 14px 16px rgba(0,0,0,.14));
    }
    .fxTitle{
      font-size: 2.2rem;
      font-weight: 1000;
      margin: 6px 0 4px;
      letter-spacing:.2px;
      color:#08101f;
    }
    .fxSub{
      margin: 0 0 12px;
      font-weight: 900;
      color: var(--muted);
      font-size: 1.08rem;
    }
    .fxBtnRow{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .fxConfettiLayer{
      position:absolute;
      inset:0;
      pointer-events:none;
      overflow:hidden;
    }
    .fxConfetti{
      position:absolute;
      width:10px; height:14px;
      border-radius:3px;
      opacity:0;
      transform: translateY(10px) rotate(0deg);
      animation: confettiFly 1000ms ease-out forwards;
      box-shadow: 0 12px 18px rgba(0,0,0,.14);
    }
    @keyframes confettiFly{
      0%{opacity:1; transform: translateY(18px) rotate(0deg);}
      100%{opacity:0; transform: translateY(-180px) rotate(280deg);}
    }

    /* Help button (reduce noise) */
    .helpRow{
      display:flex;
      justify-content:flex-end;
      margin: 0 0 8px;
    }
    .helpBtn{
      border:none;
      cursor:pointer;
      width:44px; height:44px;
      border-radius:999px;
      font-weight:1000;
      font-size:1.15rem;
      background: rgba(255,255,255,.92);
      border: var(--stroke) solid rgba(0,0,0,.06);
      box-shadow: var(--shadow2);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .helpBtn:active{transform: scale(.97)}

    .smallPill{
      display:inline-block;
      padding:7px 10px;
      border-radius:999px;
      font-weight:1000;
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,.90);
      border: var(--stroke) solid rgba(0,0,0,.06);
      margin: 0 6px 6px 0;
    }
  </style>
</head>

<body>

  <!-- Fullscreen FX overlay -->
  <div id="fxOverlay" class="fxOverlay" role="dialog" aria-modal="true" aria-label="Dialog">
    <div class="fxCard">
      <div id="fxConfettiLayer" class="fxConfettiLayer"></div>
      <div id="fxEmoji" class="fxEmoji">‚≠ê</div>
      <div id="fxTitle" class="fxTitle">Nice!</div>
      <div id="fxSub" class="fxSub"></div>
      <div class="fxBtnRow">
        <button class="btn btnBlue" id="fxCloseBtn" type="button">Continue</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="header">
      <div>
        <div class="titleWrap">
          <div class="robloxBadge" aria-hidden="true"></div>
          <div>
            <h1>Chore List</h1>
            <p class="subtitle">Hold the red button to claim. Parent approves or declines.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tabBtn kidTab tabActive" id="kidTabBtn" type="button">Kid Page</button>
      <button class="tabBtn parentTab" id="parentTabBtn" type="button">Parent Page</button>
    </div>

    <!-- KID PAGE -->
    <div id="kidPage" class="grid">
      <div class="card stickyKidHeader" id="kidScoreCard">
        <div class="starHero">
          <div class="starCountBig">
            <div class="starEmojiBig">‚≠ê</div>
            <div class="starNumberBig"><span id="starsBigKid">0</span></div>
            <div class="starOutOf">/10</div>
          </div>

          <div class="miniBadges">
            <div class="badge badgeQueue">
              <div class="big">üü°</div>
              <div>
                <div><span style="font-size:1.15rem; font-weight:1000;">Waiting:</span>
                  <span id="waitingKid" style="font-size:1.25rem; font-weight:1000;">0</span>
                </div>
                <div class="small">Bring iPad to parent</div>
              </div>
            </div>

            <div class="badge badgeStrike">
              <div class="big">‚ùå</div>
              <div>
                <div><span style="font-size:1.15rem; font-weight:1000;">Strikes:</span>
                  <span id="strikesKid" style="font-size:1.25rem; font-weight:1000;">0</span><span style="color:var(--muted)">/3</span>
                </div>
                <div class="small">3 strikes = lose 1 ‚≠ê</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress bar -->
        <div class="progressWrap">
          <div class="progressTop">
            <div>Progress</div>
            <div><span id="progressTextKid">0/10 stars</span></div>
          </div>
          <div class="progressBar" aria-hidden="true">
            <div id="progressFillKid" class="progressFill"></div>
          </div>
        </div>

        <div class="starsRow" id="starsRowKid"></div>

        <div class="goalLine">
          Daily goal <span class="goalPill" id="goalKidPill">8 ‚≠ê</span>
          Perfect <span class="goalPill">10 ‚≠ê</span>
        </div>

        <div class="statusLine" id="goalStatusKid"></div>

        <div class="divider"></div>

        <!-- Boss + Mystery -->
        <div class="sectionTitle" style="margin-bottom:8px;">Daily Specials</div>
        <div class="btnRow" style="justify-content:center;">
          <button class="btn btnBlue" id="bossBtn" type="button">üëë Boss Button (2 ‚≠ê)</button>
          <button class="btn btnPurple" id="mysteryBtn" type="button">üéÅ Mystery Chore</button>
        </div>
        <div class="smallNote" id="specialsNote" style="text-align:center; margin-top:10px;"></div>
      </div>

      <div class="card">
        <div class="helpRow">
          <button class="helpBtn" id="helpBtnKid" type="button" aria-label="Help">?</button>
        </div>

        <div class="sectionTitle">Chores</div>
        <ul id="kidChoreList"></ul>
      </div>
    </div>

    <!-- PARENT PAGE -->
    <div id="parentPage" class="hidden">
      <div class="card">
        <div class="sectionTitle">Parent Page</div>
        <div class="smallNote">Enter passcode to unlock.</div>

        <div class="formRow">
          <input id="parentPassInput" class="inputWide" type="password" placeholder="Enter passcode"
                 autocomplete="off" autocapitalize="none" />
          <button class="btn btnYellow" id="unlockBtn" type="button">Unlock</button>
          <button class="btn btnGray" id="lockBtn" type="button">Lock</button>
        </div>

        <div id="parentLockedNote" class="smallNote" style="text-align:center; margin-top:10px;">Locked.</div>
      </div>

      <div id="parentControls" class="hidden">
        <div class="grid">
          <div class="card" id="parentSummaryCard">
            <div class="sectionTitle">Today Summary</div>

            <div class="starHero" style="margin-bottom:6px;">
              <div class="starCountBig">
                <div class="starEmojiBig">‚≠ê</div>
                <div class="starNumberBig"><span id="starsBigParent">0</span></div>
                <div class="starOutOf">/10</div>
              </div>

              <div class="miniBadges">
                <div class="badge badgeStrike">
                  <div class="big">‚ùå</div>
                  <div>
                    <div><span style="font-size:1.15rem; font-weight:1000;">Strikes:</span>
                      <span id="strikesParent" style="font-size:1.25rem; font-weight:1000;">0</span><span style="color:var(--muted)">/3</span>
                    </div>
                    <div class="small">Parent controls only</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top:8px;">
              <span class="smallPill">Red: <span id="countPending">0</span></span>
              <span class="smallPill" style="background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.22);">Yellow: <span id="countClaimed">0</span></span>
              <span class="smallPill" style="background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.18);">Green: <span id="countApproved">0</span></span>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Review Claimed Chores</div>
            <div class="smallNote">Approve turns green. Decline resets to red and removes the earned star(s).</div>

            <div class="btnRow" style="margin-bottom:10px;">
              <button class="btn btnGreen" id="approveAllBtn" type="button">‚úÖ Approve All</button>
              <button class="btn btnGray" id="declineSelectedBtn" type="button">‚ùå Decline Selected</button>
              <button class="btn btnBlue" id="approveSelectedBtn" type="button">‚úÖ Approve Selected</button>
            </div>

            <ul id="parentReviewList"></ul>

            <div class="divider"></div>

            <div class="sectionTitle">Reset the Day</div>
            <div class="smallNote">Sets stars and strikes to 0 and turns all chores back to red. Clears Boss selection for the day.</div>
            <div class="btnRow">
              <button class="btn btnStrike" id="resetDayBtn" type="button">üîÑ Reset Day</button>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Manage Strikes</div>
            <div class="btnRow">
              <button class="btn btnStrike" id="addStrikeParentBtn" type="button">‚ùå Add Strike</button>
              <button class="btn btnGray" id="undoStrikeBtn" type="button">‚Ü©Ô∏è Undo Strike</button>
              <button class="btn btnGray" id="clearStrikesBtn" type="button">Clear Strikes</button>
            </div>

            <div class="divider"></div>

            <div class="smallNote" id="lastSavedLine" style="text-align:center;">Last saved: ‚Äî</div>
          </div>

          <div class="card">
            <div class="sectionTitle">Chores & Settings</div>

            <div class="sectionTitle" style="font-size:1.18rem; margin-top:2px;">Mystery Chore Prompt (parent sets)</div>
            <div class="smallNote">Kid can use it once per day.</div>
            <div class="formRow" style="justify-content:flex-start">
              <input id="mysteryPromptInput" class="inputWide" type="text" placeholder="Enter today‚Äôs mystery prompt" />
              <button class="btn btnPurple" id="saveMysteryPromptBtn" type="button">Save Prompt</button>
              <button class="btn btnGray" id="clearMysteryPromptBtn" type="button">Clear</button>
            </div>
            <div class="smallNote" style="margin-top:8px;">Current prompt: <span id="mysteryPromptStatus">None</span></div>

            <div class="divider"></div>

            <div class="sectionTitle" style="font-size:1.18rem; margin-top:2px;">Boss Button (2 ‚≠ê) - tag today‚Äôs chore</div>
            <div class="smallNote">Boss Button is inactive until you select a chore.</div>
            <div class="formRow" style="justify-content:flex-start">
              <select id="bossSelect" class="inputWide"></select>
              <button class="btn btnBlue" id="saveBossBtn" type="button">Save Boss</button>
              <button class="btn btnGray" id="clearBossBtn" type="button">Clear Boss</button>
            </div>
            <div class="smallNote" style="margin-top:8px;">Boss chore: <span id="bossStatus">None</span></div>

            <div class="divider"></div>

            <div class="sectionTitle" style="font-size:1.18rem; margin-top:2px;">Sound Effects</div>
            <div class="formRow" style="justify-content:flex-start">
              <label style="font-weight:1000; color:var(--muted); align-self:center;">Sounds</label>
              <select id="soundSelect">
                <option value="on">On</option>
                <option value="off">Off</option>
              </select>
              <button class="btn btnBlue" id="saveSoundBtn" type="button">Save</button>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle" style="font-size:1.18rem; margin-top:2px;">Add Chore</div>
            <div class="formRow" style="justify-content:flex-start">
              <input id="newChoreName" class="inputWide" type="text" placeholder="New chore name (e.g., Make bed)" />
              <button class="btn btnPurple" id="addChoreBtn" type="button">‚ûï Add</button>
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Edit / Delete / Reset</div>
            <div class="smallNote">All chores can be renamed or deleted.</div>
            <ul id="parentChoreList"></ul>

            <div class="divider"></div>

            <div class="sectionTitle">Chart Settings</div>
            <div class="formRow" style="justify-content:flex-start">
              <label style="font-weight:1000; color:var(--muted); align-self:center;">Points per chore</label>
              <input id="pointsPerChore" class="inputSmall" type="number" min="1" step="1" />
              <button class="btn btnBlue" id="saveSettingsBtn" type="button">Save</button>
            </div>

            <div class="formRow" style="justify-content:flex-start; margin-top:6px;">
              <label style="font-weight:1000; color:var(--muted); align-self:center;">Auto daily reset</label>
              <select id="autoResetSelect">
                <option value="on">On</option>
                <option value="off">Off</option>
              </select>
              <label style="font-weight:1000; color:var(--muted); align-self:center;">Daily goal stars</label>
              <input id="dailyGoalStars" class="inputSmall" type="number" min="1" max="10" step="1" />
            </div>

            <div class="divider"></div>

            <div class="sectionTitle">Save</div>
            <button class="btn btnBlue" id="manualSaveBtn" type="button">üíæ Save Now</button>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
(() => {
  const STORAGE_KEY = "kids_chore_chart_v11_sticky_help_boss_mystery";

  const MAX_STARS = 10;
  const STRIKES_MAX = 3;

  const PRAISE = [
    "Awesome work!",
    "You crushed it!",
    "Nice job, superstar!",
    "Boom! Done!",
    "Way to go!",
    "High five!",
    "You did it!",
    "Super helper!",
    "That was amazing!",
    "Great hustle!"
  ];

  // 10 defaults auto-populate (Ask parent is NOT #1)
  const DEFAULT_CHORE_TEMPLATES = [
    "Make bed, get dressed, and eat breakfast",
    "Brush teeth in the morning",
    "Put dirty clothes in the hamper",
    "Put dishes in the sink (or dishwasher)",
    "Pick up toys and clean your room floor",
    "Pack backpack / get school stuff ready",
    "Read a book for 10 minutes",
    "Brush teeth at night",
    "Ask mom/dad for a chore",
    "Help set the table"
  ];

  const defaultState = () => ({
    chores: [],
    points: 0,
    strikes: 0,
    lastDateKey: dateKey(new Date()),
    lastPerfectDayKey: "",
    mysteryUsedKey: "",
    bossUsedKey: "" // dateKey when boss used
  });

  const defaults = {
    pointsPerChore: 10,
    dailyGoalStars: 8,
    autoDailyReset: "on",
    parentPasscode: "123", // fixed
    soundOn: true,
    mysteryPrompt: "",
    bossChoreId: "", // parent selects daily
    state: defaultState(),
    meta: { lastSavedMs: 0 }
  };

  let app = loadState();
  let unlocked = false;

  // Tabs/pages
  const kidTabBtn = document.getElementById("kidTabBtn");
  const parentTabBtn = document.getElementById("parentTabBtn");
  const kidPage = document.getElementById("kidPage");
  const parentPage = document.getElementById("parentPage");

  // Kid elements
  const starsBigKid = document.getElementById("starsBigKid");
  const strikesKid = document.getElementById("strikesKid");
  const starsRowKid = document.getElementById("starsRowKid");
  const goalStatusKid = document.getElementById("goalStatusKid");
  const goalKidPill = document.getElementById("goalKidPill");
  const kidChoreList = document.getElementById("kidChoreList");
  const progressTextKid = document.getElementById("progressTextKid");
  const progressFillKid = document.getElementById("progressFillKid");
  const waitingKid = document.getElementById("waitingKid");

  const helpBtnKid = document.getElementById("helpBtnKid");

  const mysteryBtn = document.getElementById("mysteryBtn");
  const bossBtn = document.getElementById("bossBtn");
  const specialsNote = document.getElementById("specialsNote");

  // Fullscreen FX overlay
  const fxOverlay = document.getElementById("fxOverlay");
  const fxConfettiLayer = document.getElementById("fxConfettiLayer");
  const fxEmoji = document.getElementById("fxEmoji");
  const fxTitle = document.getElementById("fxTitle");
  const fxSub = document.getElementById("fxSub");
  const fxCloseBtn = document.getElementById("fxCloseBtn");

  // Parent elements
  const parentPassInput = document.getElementById("parentPassInput");
  const unlockBtn = document.getElementById("unlockBtn");
  const lockBtn = document.getElementById("lockBtn");
  const parentLockedNote = document.getElementById("parentLockedNote");
  const parentControls = document.getElementById("parentControls");

  const starsBigParent = document.getElementById("starsBigParent");
  const strikesParent = document.getElementById("strikesParent");
  const countPending = document.getElementById("countPending");
  const countClaimed = document.getElementById("countClaimed");
  const countApproved = document.getElementById("countApproved");

  const parentReviewList = document.getElementById("parentReviewList");
  const approveAllBtn = document.getElementById("approveAllBtn");
  const approveSelectedBtn = document.getElementById("approveSelectedBtn");
  const declineSelectedBtn = document.getElementById("declineSelectedBtn");

  const resetDayBtn = document.getElementById("resetDayBtn");

  const newChoreName = document.getElementById("newChoreName");
  const addChoreBtn = document.getElementById("addChoreBtn");
  const parentChoreList = document.getElementById("parentChoreList");

  const addStrikeParentBtn = document.getElementById("addStrikeParentBtn");
  const undoStrikeBtn = document.getElementById("undoStrikeBtn");
  const clearStrikesBtn = document.getElementById("clearStrikesBtn");

  const pointsPerChore = document.getElementById("pointsPerChore");
  const autoResetSelect = document.getElementById("autoResetSelect");
  const dailyGoalStars = document.getElementById("dailyGoalStars");
  const saveSettingsBtn = document.getElementById("saveSettingsBtn");

  const manualSaveBtn = document.getElementById("manualSaveBtn");

  const mysteryPromptInput = document.getElementById("mysteryPromptInput");
  const saveMysteryPromptBtn = document.getElementById("saveMysteryPromptBtn");
  const clearMysteryPromptBtn = document.getElementById("clearMysteryPromptBtn");
  const mysteryPromptStatus = document.getElementById("mysteryPromptStatus");

  const bossSelect = document.getElementById("bossSelect");
  const saveBossBtn = document.getElementById("saveBossBtn");
  const clearBossBtn = document.getElementById("clearBossBtn");
  const bossStatus = document.getElementById("bossStatus");

  const soundSelect = document.getElementById("soundSelect");
  const saveSoundBtn = document.getElementById("saveSoundBtn");

  const lastSavedLine = document.getElementById("lastSavedLine");

  // Schema + daily reset
  hardenApp();
  maybeDailyReset();

  // Ensure we have 10 chores without manual adding (only when list is empty)
  autopopulateDefaultsIfEmpty();

  // Tabs: auto-lock parent on return to kid
  kidTabBtn.addEventListener("click", () => showTab("kid"));
  parentTabBtn.addEventListener("click", () => { showTab("parent"); if(!unlocked) toast("Ask a parent"); });

  function showTab(which){
    if(which === "kid"){
      forceLockParent();
      kidPage.classList.remove("hidden");
      parentPage.classList.add("hidden");
      kidTabBtn.classList.add("tabActive");
      parentTabBtn.classList.remove("tabActive");
    } else {
      kidPage.classList.add("hidden");
      parentPage.classList.remove("hidden");
      parentTabBtn.classList.add("tabActive");
      kidTabBtn.classList.remove("tabActive");
      parentPassInput.value = "";
    }
  }

  function forceLockParent(){
    unlocked = false;
    parentControls.classList.add("hidden");
    parentLockedNote.textContent = "Locked.";
    parentPassInput.value = "";
  }

  // Unlock/lock
  unlockBtn.addEventListener("click", () => {
    if(parentPassInput.value === app.parentPasscode){
      unlocked = true;
      parentControls.classList.remove("hidden");
      parentLockedNote.textContent = "Unlocked.";
      syncParentFields();
      renderAll();
      toast("Unlocked");
    } else {
      forceLockParent();
      parentLockedNote.textContent = "Wrong passcode.";
      toast("Wrong passcode");
      if(app.soundOn) sfx("error");
    }
  });

  lockBtn.addEventListener("click", () => {
    forceLockParent();
    toast("Locked");
  });

  // FX overlay close
  fxCloseBtn.addEventListener("click", closeFx);
  fxOverlay.addEventListener("click", (e) => { if(e.target === fxOverlay) closeFx(); });
  function closeFx(){
    fxOverlay.style.display = "none";
    document.body.style.overflow = "";
  }

  // Help (reduces clutter by moving explanations into a single dialog)
  helpBtnKid.addEventListener("click", () => {
    showFx({
      emoji: "‚ùì",
      title: "How it works",
      sub: "Red = ready. Hold red to claim.\nYellow = waiting for parent.\nGreen = approved.\nBring the iPad to a parent after you claim.",
      confetti: false,
      sound: "arm"
    });
  });

  // Mystery chore: reveal only AFTER click (no pre-reveal text)
  mysteryBtn.addEventListener("click", () => {
    const prompt = (app.mysteryPrompt || "").trim();
    const today = dateKey(new Date());

    if(!prompt){
      toast("Ask a parent to set today‚Äôs mystery");
      if(app.soundOn) sfx("error");
      return;
    }
    if(app.state.mysteryUsedKey === today){
      toast("Already used today");
      if(app.soundOn) sfx("error");
      return;
    }

    showFx({
      emoji: "üéÅ",
      title: "Mystery Chore!",
      sub: prompt,
      confetti: true,
      sound: "mystery"
    });

    app.state.chores.push({
      id: rid(),
      name: "üéÅ " + prompt,
      statusToday: "pending",
      approvedAllTime: 0,
      createdAt: Date.now(),
      pointsAwarded: app.pointsPerChore
    });

    app.state.mysteryUsedKey = today;
    saveApp();
    renderAll();
  });

  // Boss button: inactive until parent tags a chore; gives 2 stars (2x points) once/day
  bossBtn.addEventListener("click", () => {
    const today = dateKey(new Date());

    if(!app.bossChoreId){
      toast("Boss is not set yet");
      if(app.soundOn) sfx("error");
      return;
    }
    if(app.state.bossUsedKey === today){
      toast("Boss already used today");
      if(app.soundOn) sfx("error");
      return;
    }

    const c = app.state.chores.find(x => x.id === app.bossChoreId);
    if(!c){
      toast("Boss chore was deleted");
      app.bossChoreId = "";
      saveApp();
      renderAll();
      return;
    }
    if(c.statusToday !== "pending"){
      toast("Boss chore is not red");
      if(app.soundOn) sfx("error");
      return;
    }

    // Claim the boss chore with 2x points (2 stars)
    claimChore(c.id, { multiplier: 2, forceBringToParent: true, title: "Boss Claimed!", emoji: "üëë" });
    app.state.bossUsedKey = today;
    saveApp();
    renderAll();
  });

  // Parent: save/clear mystery prompt
  saveMysteryPromptBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const p = (mysteryPromptInput.value || "").trim();
    if(!p) return toast("Enter a prompt");
    app.mysteryPrompt = p;

    // Reset used so it can be used immediately
    app.state.mysteryUsedKey = "";

    saveApp();
    renderAll();
    toast("Mystery saved");
  });

  clearMysteryPromptBtn.addEventListener("click", () => {
    if(!unlocked) return;
    app.mysteryPrompt = "";
    saveApp();
    renderAll();
    toast("Mystery cleared");
  });

  // Parent: boss save/clear
  saveBossBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const val = bossSelect.value || "";
    app.bossChoreId = val;
    app.state.bossUsedKey = ""; // allow use immediately after selecting
    saveApp();
    renderAll();
    toast("Boss saved");
  });

  clearBossBtn.addEventListener("click", () => {
    if(!unlocked) return;
    app.bossChoreId = "";
    app.state.bossUsedKey = "";
    saveApp();
    renderAll();
    toast("Boss cleared");
  });

  // Parent: sound
  saveSoundBtn.addEventListener("click", () => {
    if(!unlocked) return;
    app.soundOn = (soundSelect.value === "on");
    saveApp();
    toast("Sound saved");
  });

  // Parent: add chore
  addChoreBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const name = (newChoreName.value || "").trim();
    if(!name) return;
    if(app.state.chores.some(c => norm(c.name) === norm(name))) return toast("Already added");

    app.state.chores.push({
      id: rid(),
      name,
      statusToday: "pending",
      approvedAllTime: 0,
      createdAt: Date.now(),
      pointsAwarded: app.pointsPerChore
    });

    newChoreName.value = "";
    saveApp();
    renderAll();
    toast("Chore added");
  });

  // Parent: strikes
  addStrikeParentBtn.addEventListener("click", () => addStrike());
  undoStrikeBtn.addEventListener("click", () => {
    if(!unlocked) return;
    app.state.strikes = clampInt(app.state.strikes - 1, 0, STRIKES_MAX);
    saveApp(); renderAll(); toast("Strike undone");
  });
  clearStrikesBtn.addEventListener("click", () => {
    if(!unlocked) return;
    app.state.strikes = 0;
    saveApp(); renderAll(); toast("Strikes cleared");
  });

  // Parent: approve/decline
  approveAllBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const claimed = app.state.chores.filter(c => c.statusToday === "claimed");
    if(claimed.length === 0) return toast("No claimed chores");
    claimed.forEach(c => { c.statusToday = "approved"; c.approvedAllTime += 1; });
    saveApp(); renderAll(); toast("Approved all ‚úÖ");
    if(app.soundOn) sfx("approve");
  });

  approveSelectedBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const ids = getSelectedReviewIds();
    if(ids.length === 0) return toast("Select at least one");
    ids.forEach(id => approveChore(id));
    toast("Approved selected ‚úÖ");
  });

  declineSelectedBtn.addEventListener("click", () => {
    if(!unlocked) return;
    const ids = getSelectedReviewIds();
    if(ids.length === 0) return toast("Select at least one");
    ids.forEach(id => declineChore(id));
    toast("Declined selected ‚ùå");
  });

  function getSelectedReviewIds(){
    const cbs = [...parentReviewList.querySelectorAll("input[type='checkbox'][data-id]:checked")];
    return cbs.map(cb => cb.getAttribute("data-id")).filter(Boolean);
  }

  // Parent: reset day
  resetDayBtn.addEventListener("click", () => {
    if(!unlocked) return;
    resetDay();
    saveApp();
    renderAll();
    toast("Day reset");
  });

  // Parent: settings
  saveSettingsBtn.addEventListener("click", () => {
    if(!unlocked) return;
    app.pointsPerChore = clampInt(pointsPerChore.value, 1, 100);
    app.autoDailyReset = autoResetSelect.value === "off" ? "off" : "on";
    app.dailyGoalStars = clampInt(dailyGoalStars.value, 1, MAX_STARS);

    // Update existing chores default award (does not change already-earned points)
    app.state.chores.forEach(c => {
      if(!Number.isFinite(Number(c.pointsAwarded))) c.pointsAwarded = app.pointsPerChore;
      // keep existing pointsAwarded if already set
    });

    saveApp();
    renderAll();
    toast("Saved settings");
  });

  manualSaveBtn.addEventListener("click", () => {
    if(!unlocked) return;
    saveApp();
    toast("Saved");
  });

  // Initial render
  renderAll();

  // ---------------- Core logic ----------------
  function claimChore(choreId, opts = {}){
    const c = app.state.chores.find(x => x.id === choreId);
    if(!c) return;
    if(c.statusToday !== "pending") return;

    c.statusToday = "claimed";

    const multiplier = clampInt(opts.multiplier ?? 1, 1, 5);
    const award = clampInt((c.pointsAwarded ?? app.pointsPerChore) * multiplier, 1, 1000);

    const beforeStars = starsFromPoints(app.state.points);
    addPoints(app.state, award);
    const afterStars = starsFromPoints(app.state.points);

    // Move claimed to bottom (within its status group): bump createdAt
    c.createdAt = Date.now() + 5;

    saveApp();
    renderAll();

    const praise = PRAISE[Math.floor(Math.random()*PRAISE.length)];
    const bringToParent = "Bring the iPad to a parent to approve.";

    showFx({
      emoji: opts.emoji || (afterStars > beforeStars ? "‚≠ê" : "üéâ"),
      title: opts.title || praise,
      sub: (afterStars > beforeStars)
        ? `Star earned! ${bringToParent}`
        : `Claimed! ${bringToParent}`,
      confetti: true,
      sound: afterStars > beforeStars ? "star" : "claim"
    });

    maybePerfectDayCelebrate(beforeStars, afterStars);
  }

  function approveChore(choreId){
    if(!unlocked) return;
    const c = app.state.chores.find(x => x.id === choreId);
    if(!c) return;
    if(c.statusToday !== "claimed") return;

    c.statusToday = "approved";
    c.approvedAllTime += 1;

    saveApp();
    renderAll();
    if(app.soundOn) sfx("approve");
  }

  function declineChore(choreId){
    if(!unlocked) return;
    const c = app.state.chores.find(x => x.id === choreId);
    if(!c) return;
    if(c.statusToday !== "claimed") return;

    const award = clampInt(c.pointsAwarded ?? app.pointsPerChore, 1, 1000);

    const beforeStars = starsFromPoints(app.state.points);
    addPoints(app.state, -award);
    const afterStars = starsFromPoints(app.state.points);

    c.statusToday = "pending";

    // If declined chore was the boss selection, clear it so Boss Button becomes inactive again
    if(app.bossChoreId === c.id){
      app.bossChoreId = "";
      app.state.bossUsedKey = "";
    }

    saveApp();
    renderAll();

    showFx({
      emoji: "‚ùå",
      title: "Declined",
      sub: (afterStars < beforeStars) ? "Star removed. Try again." : "Reset to red.",
      confetti: false,
      sound: "decline"
    });
  }

  function resetTodayStatus(choreId){
    if(!unlocked) return;
    const c = app.state.chores.find(x => x.id === choreId);
    if(!c) return;

    if(c.statusToday === "claimed"){
      const award = clampInt(c.pointsAwarded ?? app.pointsPerChore, 1, 1000);
      addPoints(app.state, -award);
    }
    c.statusToday = "pending";

    // If reset was the boss selection, clear it so Boss Button becomes inactive
    if(app.bossChoreId === c.id){
      app.bossChoreId = "";
      app.state.bossUsedKey = "";
    }

    saveApp();
    renderAll();
    toast("Reset to red");
  }

  function addPoints(state, delta){
    const maxPoints = MAX_STARS * clampInt(app.pointsPerChore, 1, 100) * 3; // allow boss/multipliers without clipping early
    state.points = clampInt(state.points + delta, 0, maxPoints);
  }

  function starsFromPoints(points){
    const pps = clampInt(app.pointsPerChore, 1, 100);
    return clampInt(Math.floor(points / pps), 0, MAX_STARS);
  }

  function addStrike(){
    if(!unlocked) return;

    app.state.strikes = clampInt(app.state.strikes + 1, 0, STRIKES_MAX);

    if(app.soundOn) sfx("strike");

    if(app.state.strikes >= STRIKES_MAX){
      app.state.strikes = 0;
      const beforeStars = starsFromPoints(app.state.points);
      if(beforeStars > 0){
        addPoints(app.state, -app.pointsPerChore);
        saveApp();
        renderAll();
        showFx({ emoji:"üéà", title:"3 Strikes!", sub:"1 star lost.", confetti:true, sound:"lose" });
        return;
      }
      saveApp(); renderAll();
      showFx({ emoji:"üéà", title:"3 Strikes!", sub:"Be careful next time.", confetti:false, sound:"strike" });
      return;
    }

    saveApp();
    renderAll();
    showFx({ emoji:"üéà", title:"Strike Added", sub:`${app.state.strikes}/3`, confetti:false, sound:"strike" });
  }

  function resetDay(){
    app.state.points = 0;
    app.state.strikes = 0;

    app.state.chores.forEach(c => {
      c.statusToday = "pending";
    });

    app.state.lastPerfectDayKey = "";
    app.state.mysteryUsedKey = "";
    app.state.bossUsedKey = "";
    app.bossChoreId = ""; // boss must be tagged daily
    app.state.lastDateKey = dateKey(new Date());
  }

  function maybeDailyReset(){
    if(app.autoDailyReset !== "on") return;
    const today = dateKey(new Date());
    if(app.state.lastDateKey !== today){
      resetDay();
      saveApp();
    }
  }

  function autopopulateDefaultsIfEmpty(){
    if(app.state.chores.length > 0) return;

    DEFAULT_CHORE_TEMPLATES.slice(0,10).forEach((name, idx) => {
      app.state.chores.push({
        id: rid(),
        name,
        statusToday: "pending",
        approvedAllTime: 0,
        createdAt: Date.now() + idx,
        pointsAwarded: app.pointsPerChore
      });
    });

    saveApp();
  }

  // ---------------- UI rendering ----------------
  function renderAll(){
    const stars = starsFromPoints(app.state.points);

    starsBigKid.textContent = stars;
    strikesKid.textContent = app.state.strikes;
    goalKidPill.textContent = `${app.dailyGoalStars} ‚≠ê`;

    // Waiting count
    const waiting = app.state.chores.filter(c => c.statusToday === "claimed").length;
    waitingKid.textContent = waiting;

    // Progress bar
    progressTextKid.textContent = `${stars}/${MAX_STARS} stars`;
    progressFillKid.style.width = `${Math.round((stars / MAX_STARS) * 100)}%`;

    // stars row
    starsRowKid.innerHTML = "";
    for(let i=1;i<=MAX_STARS;i++){
      const s = document.createElement("span");
      s.textContent = "‚≠ê";
      if(i > stars) s.classList.add("starDim");
      starsRowKid.appendChild(s);
    }

    // goal line
    const goal = clampInt(app.dailyGoalStars, 1, MAX_STARS);
    goalStatusKid.textContent =
      (stars >= MAX_STARS) ? "Perfect day: 10 stars!"
      : (stars >= goal) ? `Goal reached: ${stars} stars (goal is ${goal}).`
      : `You have ${stars} stars. Goal is ${goal}.`;

    // Specials note + button states
    const today = dateKey(new Date());

    // Boss: inactive until tagged; then once/day
    const bossReady = !!app.bossChoreId && app.state.bossUsedKey !== today;
    bossBtn.disabled = !bossReady;
    const bossName = app.bossChoreId ? (app.state.chores.find(c => c.id === app.bossChoreId)?.name || "") : "";
    const bossLine = app.bossChoreId ? `Boss: ${bossName}${app.state.bossUsedKey === today ? " (used)" : ""}` : "Boss is not set yet.";

    // Mystery: enabled only if prompt exists and not used today (do NOT show prompt)
    const prompt = (app.mysteryPrompt || "").trim();
    const mysteryReady = !!prompt && app.state.mysteryUsedKey !== today;
    mysteryBtn.disabled = !mysteryReady;
    const mysteryLine = !prompt ? "Mystery is not set yet." : (app.state.mysteryUsedKey === today ? "Mystery used today." : "Mystery is ready.");

    specialsNote.textContent = `${bossLine}  |  ${mysteryLine}`;

    // Chores list (status order + keep claimed moved down via updated createdAt)
    kidChoreList.innerHTML = "";

    const orderWeight = (c) => {
      return (c.statusToday === "pending") ? 0 : (c.statusToday === "claimed" ? 1 : 2);
    };

    const sorted = [...app.state.chores].sort((a,b) => {
      const wa = orderWeight(a), wb = orderWeight(b);
      if(wa !== wb) return wa - wb;

      const ca = Number(a.createdAt) || 0;
      const cb = Number(b.createdAt) || 0;
      if(ca !== cb) return ca - cb;
      return String(a.name||"").localeCompare(String(b.name||""));
    });

    sorted.forEach(c => {
      const li = document.createElement("li");
      li.className = "choreItem";

      const meta =
        c.statusToday === "pending"  ? "Red"
        : c.statusToday === "claimed" ? "Waiting"
        : "Approved";

      const btnClass =
        c.statusToday === "pending" ? "btnRed"
        : c.statusToday === "claimed" ? "btnYellow"
        : "btnGreen";

      const btnText =
        c.statusToday === "pending" ? "Claim"
        : c.statusToday === "claimed" ? "Claimed"
        : "Approved";

      const statusIcon =
        c.statusToday === "pending" ? "üî¥"
        : c.statusToday === "claimed" ? "üü°"
        : "üü¢";

      li.innerHTML = `
        <div class="choreTop">
          <div class="choreName">${statusIcon} ${escapeHtml(c.name)}</div>
          <div class="choreMeta">${meta}</div>
        </div>

        <div class="btnRow">
          <button class="btn ${btnClass} ${(c.statusToday === "pending") ? "holdable" : ""}" type="button"
                  ${c.statusToday !== "pending" ? "disabled" : ""} aria-label="Claim">
            ${btnText}
          </button>
        </div>
      `;

      const mainBtn = li.querySelector(".btnRow button");

      if(c.statusToday === "pending"){
        attachHoldToClaim(mainBtn, () => claimChore(c.id));
      }

      kidChoreList.appendChild(li);
    });

    if(unlocked){
      renderParentSummary();
      renderParentReview();
      renderParentChores();
      syncParentFields();
      renderBossSelect();
      renderLastSaved();
    }
  }

  function renderParentSummary(){
    const stars = starsFromPoints(app.state.points);
    starsBigParent.textContent = stars;
    strikesParent.textContent = app.state.strikes;

    let pending=0, claimed=0, approved=0;
    app.state.chores.forEach(c => {
      if(c.statusToday === "pending") pending++;
      else if(c.statusToday === "claimed") claimed++;
      else approved++;
    });
    countPending.textContent = pending;
    countClaimed.textContent = claimed;
    countApproved.textContent = approved;
  }

  function renderParentReview(){
    parentReviewList.innerHTML = "";
    const claimedChores = [...app.state.chores]
      .filter(c => c.statusToday === "claimed")
      .sort((a,b) => (Number(a.createdAt)||0) - (Number(b.createdAt)||0));

    if(claimedChores.length === 0){
      const li = document.createElement("li");
      li.className = "choreItem";
      li.innerHTML = `<div class="choreName">No claimed chores waiting right now.</div>`;
      parentReviewList.appendChild(li);
      return;
    }

    claimedChores.forEach(c => {
      const li = document.createElement("li");
      li.className = "choreItem";
      li.innerHTML = `
        <div class="choreTop">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <input type="checkbox" data-id="${escapeAttr(c.id)}" style="width:22px; height:22px;" />
            <div class="choreName">üü° ${escapeHtml(c.name)}</div>
          </div>
          <div class="choreMeta">${(c.id === app.bossChoreId) ? "üëë Boss" : ""}</div>
        </div>
        <div class="btnRow">
          <button class="btn btnGreen" type="button">‚úÖ Approve</button>
          <button class="btn btnRed" type="button">‚ùå Decline</button>
        </div>
      `;
      const [approveBtn, declineBtn] = li.querySelectorAll("button");
      approveBtn.addEventListener("click", () => { approveChore(c.id); toast("Approved ‚úÖ"); });
      declineBtn.addEventListener("click", () => { declineChore(c.id); toast("Declined ‚ùå"); });
      parentReviewList.appendChild(li);
    });
  }

  function renderParentChores(){
    parentChoreList.innerHTML = "";

    const orderWeight = (c) => (c.statusToday === "pending" ? 0 : (c.statusToday === "claimed" ? 1 : 2));
    const sorted = [...app.state.chores].sort((a,b) => {
      const wa = orderWeight(a), wb = orderWeight(b);
      if(wa !== wb) return wa - wb;
      const ca = Number(a.createdAt) || 0;
      const cb = Number(b.createdAt) || 0;
      if(ca !== cb) return ca - cb;
      return String(a.name||"").localeCompare(String(b.name||""));
    });

    sorted.forEach(c => {
      const li = document.createElement("li");
      li.className = "choreItem";

      const statusChip =
        c.statusToday === "pending" ? `üî¥ Red`
        : c.statusToday === "claimed" ? `üü° Yellow`
        : `üü¢ Green`;

      li.innerHTML = `
        <div class="choreTop">
          <div style="flex:1; min-width:240px;">
            <div class="smallNote" style="margin:0 0 6px;">Name ${(c.id === app.bossChoreId) ? " (üëë Boss)" : ""}</div>
            <input class="inputWide" data-id="${escapeAttr(c.id)}" type="text" value="${escapeAttr(c.name)}" />
            <div style="margin-top:8px; font-weight:950; color: var(--muted);">${statusChip}</div>
          </div>
          <div class="choreMeta">Approved all-time: ${clampInt(c.approvedAllTime ?? 0, 0, 999999)}</div>
        </div>

        <div class="btnRow">
          <button class="btn btnBlue" type="button">üíæ Save Name</button>
          <button class="btn btnGray" type="button">‚Ü©Ô∏è Reset Today</button>
          <button class="btn btnStrike" type="button">üóë Delete</button>
        </div>
      `;

      const input = li.querySelector("input");
      const [saveBtn, resetBtn2, delBtn] = li.querySelectorAll("button");

      saveBtn.addEventListener("click", () => {
        const newName = (input.value || "").trim();
        if(!newName) return toast("Enter a name");

        const exists = app.state.chores.some(x => x.id !== c.id && norm(x.name) === norm(newName));
        if(exists) return toast("Duplicate name");

        c.name = newName;
        saveApp();
        renderAll();
        toast("Saved");
      });

      resetBtn2.addEventListener("click", () => resetTodayStatus(c.id));

      delBtn.addEventListener("click", () => {
        // If deleting a claimed chore, remove points that were awarded for that claim
        if(c.statusToday === "claimed"){
          const award = clampInt(c.pointsAwarded ?? app.pointsPerChore, 1, 1000);
          addPoints(app.state, -award);
        }

        // If deleting the boss selection, clear boss
        if(app.bossChoreId === c.id){
          app.bossChoreId = "";
          app.state.bossUsedKey = "";
        }

        app.state.chores = app.state.chores.filter(x => x.id !== c.id);
        saveApp();
        renderAll();
        toast("Deleted");
      });

      parentChoreList.appendChild(li);
    });
  }

  function renderBossSelect(){
    bossSelect.innerHTML = "";

    const optNone = document.createElement("option");
    optNone.value = "";
    optNone.textContent = "Select a chore‚Ä¶";
    bossSelect.appendChild(optNone);

    const pending = [...app.state.chores].filter(c => c.statusToday === "pending");
    pending.forEach(c => {
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.name;
      bossSelect.appendChild(o);
    });

    bossSelect.value = app.bossChoreId || "";
  }

  function syncParentFields(){
    pointsPerChore.value = app.pointsPerChore;
    autoResetSelect.value = app.autoDailyReset;
    dailyGoalStars.value = app.dailyGoalStars;
    soundSelect.value = app.soundOn ? "on" : "off";

    mysteryPromptInput.value = app.mysteryPrompt || "";
    mysteryPromptStatus.textContent = app.mysteryPrompt ? `"${app.mysteryPrompt}"` : "None";

    const bossName = app.bossChoreId ? (app.state.chores.find(c => c.id === app.bossChoreId)?.name || "") : "";
    bossStatus.textContent = app.bossChoreId ? `"${bossName}"` : "None";
  }

  // ---------------- Fullscreen FX overlay ----------------
  function showFx({emoji, title, sub, confetti, sound}){
    fxEmoji.textContent = emoji || "‚≠ê";
    fxTitle.textContent = title || "Nice!";
    fxSub.textContent = (sub || "").toString();

    fxConfettiLayer.innerHTML = "";
    if(confetti) fxConfettiBurst(36);

    document.body.style.overflow = "hidden";
    fxOverlay.style.display = "flex";

    if(app.soundOn && sound) sfx(sound);

    // Dialog stays 4 seconds
    setTimeout(() => {
      if(fxOverlay.style.display === "flex"){
        fxOverlay.style.display = "none";
        document.body.style.overflow = "";
      }
    }, 4000);
  }

  function fxConfettiBurst(count){
    const colors = ["#dc2626","#7c3aed","#2563eb","#16a34a","#f59e0b","#db2777","#22d3ee","#a3e635","#ffffff"];
    for(let i=0;i<count;i++){
      const c = document.createElement("div");
      c.className = "fxConfetti";
      c.style.left = Math.floor(6 + Math.random()*88) + "%";
      c.style.top = Math.floor(62 + Math.random()*18) + "%";
      c.style.background = colors[Math.floor(Math.random()*colors.length)];
      c.style.animationDuration = (800 + Math.random()*650) + "ms";
      fxConfettiLayer.appendChild(c);
      setTimeout(() => c.remove(), 1400);
    }
  }

  // ---------------- Perfect day celebration ----------------
  function maybePerfectDayCelebrate(beforeStars, afterStars){
    if(afterStars < MAX_STARS) return;
    if(beforeStars >= MAX_STARS) return;

    const today = dateKey(new Date());
    if(app.state.lastPerfectDayKey === today) return;

    app.state.lastPerfectDayKey = today;
    saveApp();

    showFx({
      emoji: "üèÜ",
      title: "PERFECT DAY!",
      sub: "10 stars unlocked. Incredible work.",
      confetti: true,
      sound: "perfect"
    });
  }

  // ---------------- Hold-to-claim (anti-scroll misfires) ----------------
  function attachHoldToClaim(buttonEl, onClaim){
    let holdTimer = null;
    let raf = null;
    let start = 0;
    let startX = 0, startY = 0;
    let armed = false;

    const HOLD_MS = 3000;
    const ARM_DELAY_MS = 200;     // prevents scroll misfires
    const MOVE_CANCEL_PX = 10;    // cancel if finger moves (scroll)

    const clear = () => {
      if(holdTimer) clearTimeout(holdTimer);
      holdTimer = null;
      if(raf) cancelAnimationFrame(raf);
      raf = null;
      buttonEl.style.setProperty("--hold", 0);
      armed = false;
    };

    const tick = () => {
      const t = performance.now();
      const p = clamp01((t - start) / HOLD_MS);
      buttonEl.style.setProperty("--hold", p);
      if(p < 1 && holdTimer) raf = requestAnimationFrame(tick);
    };

    const begin = (e) => {
      if(buttonEl.disabled) return;

      startX = e.clientX || 0;
      startY = e.clientY || 0;

      clear();
      start = performance.now();

      // Arm after a short delay
      setTimeout(() => { armed = true; }, ARM_DELAY_MS);

      holdTimer = setTimeout(() => { clear(); onClaim(); }, HOLD_MS);
      raf = requestAnimationFrame(tick);

      try{ buttonEl.setPointerCapture(e.pointerId); } catch(_){}
      if(app.soundOn) sfx("arm");
    };

    const move = (e) => {
      if(!holdTimer) return;
      const dx = Math.abs((e.clientX||0) - startX);
      const dy = Math.abs((e.clientY||0) - startY);
      if(dx > MOVE_CANCEL_PX || dy > MOVE_CANCEL_PX){
        clear();
      }
    };

    const end = () => {
      // if user released before arming, just clear
      clear();
    };

    buttonEl.addEventListener("pointerdown", begin);
    buttonEl.addEventListener("pointermove", move);
    buttonEl.addEventListener("pointerup", end);
    buttonEl.addEventListener("pointercancel", end);
    buttonEl.addEventListener("pointerleave", end);
    buttonEl.addEventListener("contextmenu", (e) => e.preventDefault());
  }

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  // ---------------- Sound effects (Web Audio) ----------------
  function sfx(type){
    if(!app.soundOn) return;

    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(!AudioCtx) return;

    let ctx;
    try{ ctx = new AudioCtx(); } catch(e){ return; }

    const now = ctx.currentTime;

    const beep = (freq, dur, gainVal, wave="sine") => {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = wave;
      o.frequency.setValueAtTime(freq, now);
      g.gain.setValueAtTime(gainVal, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
      o.connect(g); g.connect(ctx.destination);
      o.start(now); o.stop(now + dur);
    };

    const sweep = (f1, f2, dur, gainVal, wave="triangle") => {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = wave;
      o.frequency.setValueAtTime(f1, now);
      o.frequency.exponentialRampToValueAtTime(f2, now + dur);
      g.gain.setValueAtTime(gainVal, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
      o.connect(g); g.connect(ctx.destination);
      o.start(now); o.stop(now + dur);
    };

    switch(type){
      case "arm":     beep(520, 0.05, 0.045, "sine"); break;
      case "claim":   sweep(420, 620, 0.09, 0.055, "triangle"); break;
      case "star":    beep(880, 0.07, 0.06, "sine"); beep(1320, 0.06, 0.045, "sine"); break;
      case "approve": sweep(520, 780, 0.10, 0.055, "triangle"); break;
      case "decline": sweep(520, 260, 0.12, 0.05, "sawtooth"); break;
      case "strike":  beep(220, 0.12, 0.05, "square"); break;
      case "lose":    sweep(380, 190, 0.18, 0.055, "sawtooth"); break;
      case "mystery": beep(660, 0.06, 0.05, "sine"); beep(990, 0.06, 0.045, "sine"); beep(1320, 0.06, 0.04, "sine"); break;
      case "perfect":
        beep(523.25, 0.08, 0.055, "triangle");
        beep(659.25, 0.08, 0.05, "triangle");
        beep(783.99, 0.10, 0.05, "triangle");
        beep(1046.5, 0.14, 0.045, "triangle");
        break;
      case "error":   beep(180, 0.10, 0.05, "square"); break;
      default:        beep(520, 0.06, 0.04, "sine");
    }

    setTimeout(() => { try{ ctx.close(); } catch(_){ } }, 250);
  }

  // ---------------- Storage ----------------
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return deepCopy(defaults);

      const parsed = JSON.parse(raw);
      const merged = deepCopy(defaults);
      Object.assign(merged, parsed);

      merged.parentPasscode = "123";

      merged.pointsPerChore = clampInt(merged.pointsPerChore ?? 10, 1, 100);
      merged.dailyGoalStars = clampInt(merged.dailyGoalStars ?? 8, 1, MAX_STARS);
      merged.autoDailyReset = merged.autoDailyReset === "off" ? "off" : "on";
      merged.soundOn = !!merged.soundOn;
      merged.mysteryPrompt = (merged.mysteryPrompt || "").toString();
      merged.bossChoreId = (merged.bossChoreId || "").toString();

      if(!merged.state || typeof merged.state !== "object") merged.state = defaultState();
      if(!Array.isArray(merged.state.chores)) merged.state.chores = [];

      merged.state.chores = merged.state.chores.map(c => ({
        id: c.id || rid(),
        name: (c.name || "Chore").toString(),
        statusToday: normalizeStatus(c.statusToday),
        approvedAllTime: clampInt(c.approvedAllTime ?? 0, 0, 999999),
        createdAt: Number(c.createdAt) || Date.now(),
        pointsAwarded: clampInt(c.pointsAwarded ?? merged.pointsPerChore, 1, 1000)
      }));

      const maxPoints = MAX_STARS * clampInt(merged.pointsPerChore, 1, 100) * 3;
      merged.state.points = clampInt(merged.state.points ?? 0, 0, maxPoints);
      merged.state.strikes = clampInt(merged.state.strikes ?? 0, 0, STRIKES_MAX);
      merged.state.lastDateKey = (merged.state.lastDateKey || dateKey(new Date())).toString();
      merged.state.lastPerfectDayKey = (merged.state.lastPerfectDayKey || "").toString();
      merged.state.mysteryUsedKey = (merged.state.mysteryUsedKey || "").toString();
      merged.state.bossUsedKey = (merged.state.bossUsedKey || "").toString();

      if(!merged.meta || typeof merged.meta !== "object") merged.meta = { lastSavedMs: 0 };
      merged.meta.lastSavedMs = Number(merged.meta.lastSavedMs) || 0;

      // If boss chore no longer exists, clear
      if(merged.bossChoreId && !merged.state.chores.some(c => c.id === merged.bossChoreId)){
        merged.bossChoreId = "";
        merged.state.bossUsedKey = "";
      }

      return merged;
    } catch(e){
      return deepCopy(defaults);
    }
  }

  function saveApp(){
    try{
      app.meta = app.meta || {};
      app.meta.lastSavedMs = Date.now();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(app));
    } catch(e){}
  }

  function renderLastSaved(){
    const ms = Number(app.meta?.lastSavedMs) || 0;
    if(!ms){ lastSavedLine.textContent = "Last saved: ‚Äî"; return; }
    const d = new Date(ms);
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    lastSavedLine.textContent = `Last saved: ${hh}:${mm}`;
  }

  function deepCopy(obj){ return JSON.parse(JSON.stringify(obj)); }

  function normalizeStatus(s){
    return (s === "claimed" || s === "approved" || s === "pending") ? s : "pending";
  }

  function hardenApp(){
    app.parentPasscode = "123";

    if(!app.state || typeof app.state !== "object") app.state = defaultState();
    if(!Array.isArray(app.state.chores)) app.state.chores = [];

    app.state.chores = app.state.chores.map(c => ({
      id: c.id || rid(),
      name: (c.name || "Chore").toString(),
      statusToday: normalizeStatus(c.statusToday),
      approvedAllTime: clampInt(c.approvedAllTime ?? 0, 0, 999999),
      createdAt: Number(c.createdAt) || Date.now(),
      pointsAwarded: clampInt(c.pointsAwarded ?? app.pointsPerChore ?? 10, 1, 1000)
    }));

    app.pointsPerChore = clampInt(app.pointsPerChore ?? 10, 1, 100);
    app.dailyGoalStars = clampInt(app.dailyGoalStars ?? 8, 1, MAX_STARS);
    app.autoDailyReset = app.autoDailyReset === "off" ? "off" : "on";
    app.soundOn = !!app.soundOn;
    app.mysteryPrompt = (app.mysteryPrompt || "").toString();
    app.bossChoreId = (app.bossChoreId || "").toString();

    const maxPoints = MAX_STARS * clampInt(app.pointsPerChore, 1, 100) * 3;
    app.state.points = clampInt(app.state.points ?? 0, 0, maxPoints);
    app.state.strikes = clampInt(app.state.strikes ?? 0, 0, STRIKES_MAX);
    app.state.lastDateKey = (app.state.lastDateKey || dateKey(new Date())).toString();
    app.state.lastPerfectDayKey = (app.state.lastPerfectDayKey || "").toString();
    app.state.mysteryUsedKey = (app.state.mysteryUsedKey || "").toString();
    app.state.bossUsedKey = (app.state.bossUsedKey || "").toString();

    app.meta = app.meta || { lastSavedMs: 0 };
    app.meta.lastSavedMs = Number(app.meta.lastSavedMs) || 0;

    // Clear boss if deleted
    if(app.bossChoreId && !app.state.chores.some(c => c.id === app.bossChoreId)){
      app.bossChoreId = "";
      app.state.bossUsedKey = "";
    }

    saveApp();
  }

  // ---------------- Helpers ----------------
  function clampInt(v, min, max){
    const n = Number(v);
    if(!Number.isFinite(n)) return min;
    return Math.max(min, Math.min(max, Math.round(n)));
  }

  function dateKey(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function rid(){
    try{
      if(crypto && crypto.randomUUID) return "c_" + crypto.randomUUID();
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return "c_" + a[0].toString(16) + a[1].toString(16);
    } catch(e){
      return "c_" + Math.random().toString(16).slice(2);
    }
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function escapeAttr(str){ return escapeHtml(str); }

  function toast(msg){
    const t = document.createElement("div");
    t.className = "toast";
    t.textContent = msg;
    document.body.appendChild(t);
    // keep for 4 seconds (align with dialog timing)
    setTimeout(() => t.remove(), 4000);
  }

  function norm(s){
    return String(s||"").trim().toLowerCase();
  }

})();
</script>
</body>
</html>
